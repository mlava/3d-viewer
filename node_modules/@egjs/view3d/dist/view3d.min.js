/*
Copyright (c) NAVER Corp.
name: @egjs/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.10.1
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["three","@egjs/component"],t):(e=e||self).View3D=t(e.THREE,e.Component)}(this,function(O,o){"use strict";class l extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,l.prototype),this.name="View3DError",this.code=t}}var r={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,FILE_NOT_SUPPORTED:5,NOT_INITIALIZED:6,MODEL_FAIL_TO_LOAD:7},h=r,c={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const P=e=>"number"==typeof e,n=e=>"string"==typeof e,N=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,F=(e,t)=>{let i=null;if(n(e)){t=(t||document).querySelector(e);if(!t)return null;i=t}else N(e)&&(i=e);return i},ee=(e,t)=>{t=F(e,t);if(t)return t;throw n(e)?new l(c.ELEMENT_NOT_FOUND(e),h.ELEMENT_NOT_FOUND):new l(c.WRONG_TYPE(e,["HTMLElement","string"]),h.WRONG_TYPE)},U=(e,t)=>{e=e.querySelector(t);if(e)return e;throw new l(c.CANVAS_NOT_FOUND,h.CANVAS_NOT_FOUND)},B=e=>{if(!n(e))return!1;var t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0},k=e=>!e||e<=0?[]:Array.apply(0,Array(e)).map((e,t)=>t),_=e=>e*Math.PI/180,p=e=>180*e/Math.PI,d=(e,t,i)=>Math.max(Math.min(e,i),t),H=(e,t,i)=>e*(1-i)+t*i,u=(e,t,i)=>{var s=Math.abs(i-t);return e<t?e=i-(t-e)%s:i<e&&(e=t+(e-i)%s),e},G=(s,...e)=>(e.forEach(i=>{Object.keys(i).forEach(e=>{var t=i[e];Array.isArray(s[e])&&Array.isArray(t)?s[e]=[...s[e],...t]:s[e]=t})}),s);const V=e=>{let t=1;for(;t<e;)t*=2;return t};const z=(e,t,i)=>{t=(new O.Vector2).subVectors(t,e).normalize(),i=(new O.Vector2).subVectors(i,e).normalize().angle()-t.angle(),e=-Math.sign(i)*(2*Math.PI-Math.abs(i));return Math.abs(i)<Math.abs(e)?i:e},Z=e=>"object"==typeof e?e:{},W=e=>e?"true":"false",j=(e,t,i)=>{var t=_(t),i=_(i),s=new O.Vector3(0,0,0);return s.y=e*Math.sin(i),s.z=e*Math.cos(i),s.x=s.z*Math.sin(-t),s.z=s.z*Math.cos(-t),s},K=e=>{var t=new O.Vector2(e.x,e.z),i=new O.Vector2;return{yaw:Math.abs(e.y)<=.99?z(i,new O.Vector2(0,1),t):0,pitch:Math.atan2(e.y,t.distanceTo(i))}},X=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t},q=e=>{var t;return e.normalized&&ArrayBuffer.isView(e.array)?(e=e.array,t=te(e),e=1/(Math.pow(2,8*e.BYTES_PER_ELEMENT)-1),t?2*e:e):1},Y=(e,t,i,s)=>{var r=t.geometry,n=r.attributes.position,a=r.attributes.skinIndex,r=r.attributes.skinWeight;const o=t.skeleton.boneMatrices;n=(new O.Vector3).fromBufferAttribute(n,e).multiplyScalar(i);const l=new O.Vector4(0,0,0,0),h=new O.Vector4(n.x,n.y,n.z).applyMatrix4(t.bindMatrix);i=[r.getX(e),r.getY(e),r.getZ(e),r.getW(e)].map(e=>e*s);const c=[a.getX(e),a.getY(e),a.getZ(e),a.getW(e)];i.forEach((e,t)=>{t=(new O.Matrix4).fromArray(o,16*c[t]);l.add(h.clone().applyMatrix4(t).multiplyScalar(e))});n=(new O.Vector3).fromArray(l.applyMatrix4(t.bindMatrixInverse).toArray());return n.applyMatrix4(t.matrixWorld),n},te=e=>{e=new e.constructor(1);return e[0]=-1,e[0]<0},ie=e=>{if(e.capabilities.isWebGL2)return!0;{var e=e.getContext(),i=e.createTexture();let t=!0;try{var s=new Uint16Array(4),r=e.getExtension("OES_texture_half_float");t=!!r&&(e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,r.HALF_FLOAT_OES,s),e.getError()===e.NO_ERROR)}catch(e){t=!1}return e.deleteTexture(i),t}},se=(e,t,i)=>{if(!e||t<0||i<0)return null;e=e.meshes[t];const s=null==(t=null==e?void 0:e.geometry.index)?void 0:t.array;t=s?k(3).map(e=>s[3*i+e]):null;if(!e||!s||!t||t.some(e=>null==e))return null;const r=e.geometry.getAttribute("position");return t.map(e=>(new O.Vector3).fromBufferAttribute(r,e))},re=(e,t,i)=>{var s=se(e,t,i);if(!s)return null;const r=e.meshes[t],n=r.geometry.getIndex().array.slice(3*i,3*i+3);if(r.isSkinnedMesh){e=r.geometry,t=e.attributes.position,i=e.attributes.skinWeight;const a=q(t),o=q(i);s.forEach((e,t)=>{t=n[t],t=Y(t,r,a,o);e.copy(t)})}else s.forEach(e=>{e.applyMatrix4(r.matrixWorld)});return s};var ne;const ae=(e,t,i=!1)=>!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e),oe=(e,t)=>{const s=t.min.toArray(),r=(new O.Vector3).subVectors(t.max,t.min).toArray();return(new O.Vector3).fromArray(e.map((e,t)=>{var i;return n(e)?(i=.01*parseFloat(e),s[t]+i*r[t]):e}))};function le(e,t){var i={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]]);return i}function Q(e,a,o,l){return new(o=o||Promise)(function(i,t){function s(e){try{n(l.next(e))}catch(e){t(e)}}function r(e){try{n(l.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,r)}n((l=l.apply(e,a||[])).next())})}const m={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",POINTER_UP:"pointerup",POINTER_ENTER:"pointerenter",POINTER_LEAVE:"pointerleave",LOAD:"load",ERROR:"error",CLICK:"click",DOUBLE_CLICK:"dblclick",CONTEXT_LOST:"webglcontextlost",CONTEXT_RESTORED:"webglcontextrestored"},i={GRAB:"grab",GRABBING:"grabbing",NONE:""},he=((e=ne=ne||{})[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT","anonymous"),E="div",ce="button",$="auto",f={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",INPUT_START:"inputStart",INPUT_END:"inputEnd",CAMERA_CHANGE:"cameraChange",ANIMATION_START:"animationStart",ANIMATION_LOOP:"animationLoop",ANIMATION_FINISHED:"animationFinished",ANNOTATION_FOCUS:"annotationFocus",ANNOTATION_UNFOCUS:"annotationUnfocus",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced",QUICK_LOOK_TAP:"quickLookTap"},de={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}},J={WRAPPER:"view3d-wrapper",CANVAS:"view3d-canvas",POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay",ANNOTATION_WRAPPER:"view3d-annotation-wrapper",ANNOTATION:"view3d-annotation",ANNOTATION_TOOLTIP:"view3d-annotation-tooltip",ANNOTATION_DEFAULT:"default",ANNOTATION_SELECTED:"selected",ANNOTATION_HIDDEN:"hidden",ANNOTATION_FLIP_X:"flip-x",ANNOTATION_FLIP_Y:"flip-y",CTX_LOST:"ctx-lost"},ue={LINEAR:O.LinearToneMapping,REINHARD:O.ReinhardToneMapping,CINEON:O.CineonToneMapping,ACES_FILMIC:O.ACESFilmicToneMapping},_e={FOV:"fov",DISTANCE:"distance"};var e={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const pe={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var v;const g={ROTATE:0,TRANSLATE:1,ZOOM:2},me={ONE:"one",NONE:"none",ALL:"all"};class ve{constructor(e){this._defaultRenderLoop=e=>{var{control:t,autoPlayer:i,animator:s}=this._view3D;(s.animating||t.animating||i.animating)&&this._renderFrame(e)},this._onContextLost=()=>{this._canvas.classList.add(J.CTX_LOST)},this._onContextRestore=()=>{var e=this._canvas,t=this._view3D.scene;e.classList.remove(J.CTX_LOST),t.initTextures(),this.renderSingleFrame()};var t=U(e.rootEl,e.canvasSelector),i=(this._canvas=t,this._view3D=e,this._renderQueued=!1,new O.WebGLRenderer({canvas:t,alpha:!0,antialias:!0,preserveDrawingBuffer:!0}));i.toneMapping=e.toneMapping,i.toneMappingExposure=e.exposure,i.outputEncoding=O.sRGBEncoding,i.setClearColor(0,0),this._halfFloatAvailable=ie(i),this._renderer=i,this._clock=new O.Clock(!1),this._canvasSize=new O.Vector2,t.addEventListener(m.CONTEXT_LOST,this._onContextLost),t.addEventListener(m.CONTEXT_RESTORED,this._onContextRestore)}get canvas(){return this._canvas}get context(){return this._renderer.getContext()}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new O.Vector2);return{width:e.width,height:e.y}}get canvasSize(){return this._canvasSize}get capabilities(){var e=this._renderer;return Object.assign(Object.assign({},e.capabilities),{halfFloat:this._halfFloatAvailable})}destroy(){var e=this._canvas;this.stopAnimationLoop(),this._renderer.dispose(),e.removeEventListener(m.CONTEXT_LOST,this._onContextLost),e.removeEventListener(m.CONTEXT_RESTORED,this._onContextRestore)}resize(){var e,t=this._renderer,i=this._canvas;t.xr.isPresenting||(e=i.clientWidth||1,i=i.clientHeight||1,t.setPixelRatio(window.devicePixelRatio),t.setSize(e,i,!1),this._canvasSize.set(e,i))}setAnimationLoop(s){const r=this._view3D,n=this._clock;n.start(),this._renderer.setAnimationLoop((e,t)=>{var i=Math.min(n.getDelta(),r.maxDeltaTime);s(i,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}renderSingleFrame(e=!1){this._renderer.xr.isPresenting||(e?this._renderFrame(0):this._renderQueued||(requestAnimationFrame(()=>{this._renderFrame(0)}),this._renderQueued=!0))}_renderFrame(e){var t,i=this._view3D,s=this._renderer,{scene:r,camera:n,control:a,autoPlayer:o,animator:l,annotation:h}=i;s.getContext().isContextLost()||(t=1e3*e,this._renderQueued=!1,l.update(e),a.update(t),o.update(t),i.trigger(f.BEFORE_RENDER,{type:f.BEFORE_RENDER,target:i,delta:t}),n.updatePosition(),r.shadowPlane.render(),s.render(r.root,n.threeCamera),h.render(),i.trigger(f.RENDER,{type:f.RENDER,target:i,delta:t}))}}class ge extends O.DataTextureLoader{constructor(e){super(e),this.type=O.HalfFloatType}parse(e){const i=-1,m=1,s=2,v=3,g=4,E=function(e,t){switch(e){case m:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case s:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case v:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case g:console.error("THREE.RGBELoader: Error: "+(t||""))}return i},l=1,h=2,c=4,d="\n",u=function(e,t,i){t=t||1024;let s=e.pos,r=-1,n=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));for(;(r=o.indexOf(d))<0&&n<t&&s<e.byteLength;)a+=o,n+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));return-1<r&&(!1!==i&&(e.pos+=n+r+1),a+o.slice(0,r))};var r,n,a,o,_,p,f,T,w,b,e=new Uint8Array(e),y=(e.pos=0,function(e){var t=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*FORMAT=(\S+)\s*$/,r=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,n={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let a,o;if(e.pos>=e.byteLength||!(a=u(e)))return E(m,"no header found");if(!(o=a.match(/^#\?(\S+)/)))return E(v,"bad initial token");for(n.valid|=l,n.programtype=o[1],n.string+=a+"\n";;){if(!1===(a=u(e)))break;if(n.string+=a+"\n","#"===a.charAt(0))n.comments+=a+"\n";else if((o=a.match(t))&&(n.gamma=parseFloat(o[1],10)),(o=a.match(i))&&(n.exposure=parseFloat(o[1],10)),(o=a.match(s))&&(n.valid|=h,n.format=o[1]),(o=a.match(r))&&(n.valid|=c,n.height=parseInt(o[1],10),n.width=parseInt(o[2],10)),n.valid&h&&n.valid&c)break}return n.valid&h?n.valid&c?n:E(v,"missing image size specifier"):E(v,"missing format specifier")}(e));if(i!==y){var S=y.width,A=y.height,L=function(e,t,i){var s=t;if(s<8||32767<s||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(s!==(e[2]<<8|e[3]))return E(v,"wrong scanline width");var r=new Uint8Array(4*t*i);if(!r.length)return E(g,"unable to allocate buffer space");let n=0,a=0;var o=4*s,l=new Uint8Array(4),h=new Uint8Array(o);let c=i;for(;0<c&&a<e.byteLength;){if(a+4>e.byteLength)return E(m);if(l[0]=e[a++],l[1]=e[a++],l[2]=e[a++],l[3]=e[a++],2!=l[0]||2!=l[1]||(l[2]<<8|l[3])!=s)return E(v,"bad rgbe scanline format");let t=0,i;for(;t<o&&a<e.byteLength;){var d=128<(i=e[a++]);if(d&&(i-=128),0===i||t+i>o)return E(v,"bad scanline data");if(d){var u=e[a++];for(let e=0;e<i;e++)h[t++]=u}else h.set(e.subarray(a,a+i),t),t+=i,a+=i}var _=s;for(let e=0;e<_;e++){var p=0;r[n]=h[e+0],p+=s,r[n+1]=h[e+p],p+=s,r[n+2]=h[e+p],p+=s,r[n+3]=h[e+p],n+=4}c--}return r}(e.subarray(e.pos),S,A);if(i!==L){let e,t,i,s;switch(this.type){case O.UnsignedByteType:e=L,t=O.RGBEFormat,i=O.UnsignedByteType;break;case O.FloatType:s=L.length/4;var R=new Float32Array(3*s);for(let e=0;e<s;e++)p=L,f=4*e,T=R,w=3*e,b=void 0,b=p[f+3],b=Math.pow(2,b-128)/255,T[w+0]=p[f+0]*b,T[w+1]=p[f+1]*b,T[w+2]=p[f+2]*b;e=R,t=O.RGBFormat,i=O.FloatType;break;case O.HalfFloatType:s=L.length/4;var x=new Uint16Array(3*s);for(let e=0;e<s;e++)r=L,n=4*e,a=x,o=3*e,_=void 0,_=r[n+3],_=Math.pow(2,_-128)/255,a[o+0]=O.DataUtils.toHalfFloat(Math.min(r[n+0]*_,65504)),a[o+1]=O.DataUtils.toHalfFloat(Math.min(r[n+1]*_,65504)),a[o+2]=O.DataUtils.toHalfFloat(Math.min(r[n+2]*_,65504));e=x,t=O.RGBFormat,i=O.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:S,height:A,data:e,header:y.string,gamma:y.gamma,exposure:y.exposure,format:t,type:i}}}return null}setDataType(e){return this.type=e,this}load(e,i,t,s){return super.load(e,function(e,t){switch(e.type){case O.UnsignedByteType:e.encoding=O.RGBEEncoding,e.minFilter=O.NearestFilter,e.magFilter=O.NearestFilter,e.generateMipmaps=!1,e.flipY=!0;break;case O.FloatType:case O.HalfFloatType:e.encoding=O.LinearEncoding,e.minFilter=O.LinearFilter,e.magFilter=O.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}i&&i(e,t)},t,s)}}class Ee{constructor(e){this._onLoadingProgress=(e,t,i)=>{var s=this._view3D;i.initialized=!0,i.lengthComputable=e.lengthComputable,i.loaded=e.loaded,i.total=e.total,s.trigger(f.PROGRESS,{type:f.PROGRESS,target:s,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class fe extends Ee{constructor(e){super(e)}load(r){const n=this._view3D;return new Promise((e,t)=>{var i=new O.TextureLoader;const s=X(n,r);i.setCrossOrigin(he),i.load(r,e,e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,t(e)})})}loadHDRTexture(r){const n=this._view3D;return new Promise((t,i)=>{var e=new ge;n.renderer.capabilities.halfFloat||(e.type=O.FloatType);const s=X(n,r);e.setCrossOrigin(he),e.load(r,e=>{e.mapping=O.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,i(e)})})}}const Te=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap","sheenColorMap","sheenRoughnessMap","specularColorMap","specularIntensityMap","transmissionMap","clearcoatMap","clearcoatNormalMap"],T={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"},we=((t=v=v||{})[t.NONE=0]="NONE",t[t.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",t[t.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",t[t.ONE_FINGER=3]="ONE_FINGER",t[t.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",t[t.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",t[t.TWO_FINGER=12]="TWO_FINGER",t[t.PINCH=16]="PINCH","KHR_materials_variants"),be="EXT_View3D_texture_LOD",ye="view3d-lod",Se="view3d-annotation";var w,a,Ae={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float h;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

			gl_FragColor = sum;

		}`};const Le={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float v;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

			gl_FragColor = sum;

		}`};class Re{constructor(e,{darkness:t=.5,mapSize:i=9,blur:s=3.5,shadowScale:r=1,planeScale:n=2}={}){this._view3D=e,this._darkness=t,this._mapSize=i,this._blur=s,this._shadowScale=r,this._planeScale=n;t=e.renderer.threeRenderer,s=Math.min(Math.pow(2,Math.floor(i)),t.capabilities.maxTextureSize),this._root=new O.Group,this._renderTarget=new O.WebGLRenderTarget(s,s,{format:O.RGBAFormat}),this._blurTarget=new O.WebGLRenderTarget(s,s,{format:O.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1,r=new O.OrthographicCamera(-.5,.5,.5,-.5,0),r.rotation.x=Math.PI/2,this._shadowCamera=r,this._root.add(r),n=new O.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=n,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}set darkness(e){this._plane.material.opacity=e,this._darkness=e}set blur(e){this._blur=e}set shadowScale(e){this._shadowScale=e;e=this._view3D.model;e&&this.updateDimensions(e)}updateDimensions(e){var t=this._root,i=this._shadowCamera,s=this._planeScale,r=e.bbox.getBoundingSphere(new O.Sphere),s=2*s*r.radius,n=this._shadowScale;i.far=n*(e.bbox.max.y-e.bbox.min.y)/s,i.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(r.center).setY(e.bbox.min.y),t.scale.setScalar(s),i.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:i}=e,s=this._shadowCamera,t=t.threeRenderer,i=i.activeSession?i.activeSession.arScene:e.scene,e=t.xr.enabled,i=(t.xr.enabled=!1,i.root),r=i.background,n=(i.background=null,i.overrideMaterial=this._depthMaterial,t.getClearAlpha()),a=(t.setClearAlpha(0),t.getRenderTarget());t.setRenderTarget(this._renderTarget),t.clear(),t.render(i,s),i.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),t.xr.enabled=e,t.setRenderTarget(a),t.setClearAlpha(n),i.background=r,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],i=this._blurCamera,t=t.threeRenderer,s=this._blurPlane,r=this._renderTarget,n=this._blurTarget,a=this._horizontalBlurMaterial,o=this._verticalBlurMaterial;s.visible=!0,a.uniforms.tDiffuse.value=r.texture,a.uniforms.h.value=+e/256,a.needsUpdate=!0,s.material=a,t.setRenderTarget(n),t.render(s,i),o.uniforms.tDiffuse.value=n.texture,o.uniforms.v.value=+e/256,o.needsUpdate=!0,s.material=o,t.setRenderTarget(r),t.render(s,i),s.visible=!1}_setupPlanes(){var e=this._root,t=new O.PlaneBufferGeometry,i=new O.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:O.BackSide,depthWrite:!1,map:this._renderTarget.texture}),i=new O.Mesh(t,i),e=(i.renderOrder=1,i.scale.set(-1,-1,1),i.rotation.order="YXZ",i.rotation.x=Math.PI/2,this._plane=i,e.add(i),new O.Mesh(t)),i=(this._blurPlane=e,new O.MeshDepthMaterial),t=(i.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=i,new O.ShaderMaterial(Ae)),e=(t.depthTest=!1,this._horizontalBlurMaterial=t,new O.ShaderMaterial(Le));e.depthTest=!1,this._verticalBlurMaterial=e}}class xe{static fromCubeTexture(s){let r=0;var n=new O.Vector3,a=new O.Vector3,o=new O.Color,l=[0,0,0,0,0,0,0,0,0],e=new O.SphericalHarmonics3,h=e.coefficients;for(let i=0;i<6;i++){var t=s.image[i],c=t.width,d=t.height,u=document.createElement("canvas"),u=(u.width=c,u.height=d,u.getContext("2d")),t=(u.drawImage(t,0,0,c,d),u.getImageData(0,0,c,d)),_=t.data,p=t.width,m=2/p;for(let e=0,t=_.length;e<t;e+=4){o.setRGB(_[e]/255,_[e+1]/255,_[e+2]/255),Oe(o,s.encoding);var v=e/4,g=(v%p+.5)*m-1,E=1-(Math.floor(v/p)+.5)*m;switch(i){case 0:n.set(-1,E,-g);break;case 1:n.set(1,E,g);break;case 2:n.set(-g,1,-E);break;case 3:n.set(-g,-1,E);break;case 4:n.set(-g,E,1);break;case 5:n.set(g,E,-1)}var v=n.lengthSq(),f=4/(Math.sqrt(v)*v);r+=f,a.copy(n).normalize(),O.SphericalHarmonics3.getBasisAt(a,l);for(let e=0;e<9;e++)h[e].x+=l[e]*o.r*f,h[e].y+=l[e]*o.g*f,h[e].z+=l[e]*o.b*f}}var i=4*Math.PI/r;for(let e=0;e<9;e++)h[e].x*=i,h[e].y*=i,h[e].z*=i;return new O.LightProbe(e)}static fromCubeRenderTarget(e,s){let r=0;var n=new O.Vector3,a=new O.Vector3,o=new O.Color,l=[0,0,0,0,0,0,0,0,0],t=new O.SphericalHarmonics3,h=t.coefficients;for(let i=0;i<6;i++){var c=s.width,d=new Uint8Array(c*c*4),u=(e.readRenderTargetPixels(s,0,0,c,c,d,i),2/c);for(let e=0,t=d.length;e<t;e+=4){o.setRGB(d[e]/255,d[e+1]/255,d[e+2]/255),Oe(o,s.texture.encoding);var _=e/4,p=(_%c+.5)*u-1,m=1-(Math.floor(_/c)+.5)*u;switch(i){case 0:n.set(1,m,-p);break;case 1:n.set(-1,m,p);break;case 2:n.set(p,1,-m);break;case 3:n.set(p,-1,m);break;case 4:n.set(p,m,1);break;case 5:n.set(-p,m,-1)}var _=n.lengthSq(),v=4/(Math.sqrt(_)*_);r+=v,a.copy(n).normalize(),O.SphericalHarmonics3.getBasisAt(a,l);for(let e=0;e<9;e++)h[e].x+=l[e]*o.r*v,h[e].y+=l[e]*o.g*v,h[e].z+=l[e]*o.b*v}}var i=4*Math.PI/r;for(let e=0;e<9;e++)h[e].x*=i,h[e].y*=i,h[e].z*=i;return new O.LightProbe(t)}}function Oe(e,t){switch(t){case O.sRGBEncoding:e.convertSRGBToLinear();break;case O.LinearEncoding:break;default:console.warn("WARNING: LightProbeGenerator convertColorToLinear() encountered an unsupported encoding.")}}class b{static createDefaultEnv(e){var t=new O.Scene,i=new O.PointLight(16777215,.8,20),i=(i.decay=2,i.position.set(0,7,0),t.add(i),new O.BoxBufferGeometry(1,1,1)),s=new O.MeshStandardMaterial({side:O.BackSide}),i=new O.Mesh(i,s),s=(i.castShadow=!1,i.scale.set(15,45,15),i.position.set(0,20,0),t.add(i),b._createRectAreaLightSource({intensity:4.5,width:4,height:4})),i=(s.position.set(0,2.5,0),s.rotateX(Math.PI/2),b._createRectAreaLightSource({intensity:3,width:2,height:2})),r=(i.position.set(0,1,4),i.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),n=(r.position.set(-4,1,1),r.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),a=(n.position.set(4,1,1),n.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2})),o=(a.position.set(1.5,1,-4),a.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2})),s=(o.position.set(-1.5,1,-4),o.lookAt(0,0,0),t.add(s,i,r,n,a,o),e.outputEncoding),i=e.toneMapping,r=(e.outputEncoding=O.LinearEncoding,e.toneMapping=O.NoToneMapping,new O.PMREMGenerator(e).fromScene(t,.035));return e.outputEncoding=s,e.toneMapping=i,r.texture}static createBlurredHDR(e,t){var e=e.renderer.threeRenderer,i=new O.Scene,t=(i.background=t,e.toneMappingExposure),s=(e.toneMappingExposure=1,new O.WebGLCubeRenderTarget(256,{encoding:O.sRGBEncoding,format:O.RGBAFormat})),r=new O.CubeCamera(.1,1e3,s),i=(r.update(e,i),xe.fromCubeRenderTarget(e,s)),n=new O.MeshStandardMaterial({side:O.BackSide}),a=new O.IcosahedronBufferGeometry(1,4),o=new O.Scene,n=new O.Mesh(a,n),l=a.getAttribute("normal");for(let e=0;e<l.count;e++)l.setXYZ(e,-l.getX(e),-l.getY(e),-l.getZ(e));return o.add(n),o.add(i),r.update(e,o),e.toneMappingExposure=t,s.texture}static _createRectAreaLightSource({intensity:e,width:t,height:i}){t=new O.PlaneBufferGeometry(t,i),i=new O.MeshBasicMaterial;return i.color.setScalar(e),new O.Mesh(t,i)}}class Ce{constructor(e){this._view3D=e,this._root=new O.Scene,this._userObjects=new O.Group,this._envObjects=new O.Group,this._fixedObjects=new O.Group,this._shadowPlane=new Re(e,Z(e.shadow));var t=this._root,i=this._userObjects,s=this._envObjects,r=this._fixedObjects,n=this._shadowPlane;i.name="userObjects",s.name="envObjects",r.name="fixedObjects",t.add(i,s,r),e.shadow&&r.add(n.root)}get root(){return this._root}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){t=t?this._userObjects:this._envObjects,e=Array.isArray(e)?e:[e];t.add(...e)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(s){return Q(this,void 0,void 0,function*(){var e,t=this._view3D,i=this._root;"number"==typeof s||"#"===s.charAt(0)?i.background=new O.Color(s):((e=yield new fe(t).load(s)).encoding=O.sRGBEncoding,i.background=e),t.renderer.renderSingleFrame()})}setSkybox(s){return Q(this,void 0,void 0,function*(){var e,t=this._root,i=this._view3D;t.background&&t.background.isTexture&&t.background.dispose(),s?(e=yield new fe(i).loadHDRTexture(s),i.skyboxBlur?t.background=b.createBlurredHDR(i,e):t.background=e,t.environment=e):(t.background=null,t.environment=null),i.renderer.renderSingleFrame()})}setEnvMap(s){return Q(this,void 0,void 0,function*(){var e,t=this._view3D,i=this._root;s?(e=yield new fe(t).loadHDRTexture(s),i.environment=e):i.environment=null,t.renderer.renderSingleFrame()})}initTextures(){var{skybox:e,envmap:t,background:i,useDefaultEnv:s}=this._view3D,r=[],s=(s&&this.setDefaultEnv(),e||t);return s&&(s=e?this.setSkybox(e):this.setEnvMap(t),r.push(s)),!e&&i&&r.push(this.setBackground(i)),r}setDefaultEnv(){var e=this._view3D.renderer,e=b.createDefaultEnv(e.threeRenderer);this._root.environment=e}_removeChildsOf(e){for(e.traverse(e=>{e.isMesh&&((e=e).geometry.dispose(),(Array.isArray(e.material)?e.material:[e.material]).forEach(t=>{Te.forEach(e=>{t[e]&&t[e].dispose()})}))});0<e.children.length;)e.remove(e.children[0])}}const y=de.EASE_OUT_CUBIC,Me={min:0,max:1},Ie={min:-1/0,max:1/0},De={min:-89.9,max:89.9},Pe={165:0,135:.4,0:1},Ne=[e.WEBXR,e.SCENE_VIEWER,e.QUICK_LOOK];class S{constructor({duration:e=300,loop:t=!1,range:i=Me,easing:s=y}={}){this._duration=e,this._loop=t,this._range=i,this._easing=s,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}get activated(){return this._activated}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){var t,i,s,r,n;return this._activated?(t=this._start,i=this._end,n=this._duration,s=this._val,r=this._loop,e=this._progress+e/n,this._progress=(r?u:d)(e,0,1),n=this._easing(this._progress),this._val=H(t,i,n),!r&&1<=this._progress&&(this._activated=!1),this._val-s):0}reset(e){var t=this._range,e=d(e,t.min,t.max);this._start=e,this._end=e,this._val=e,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=d(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class Fe{constructor(e,t,i,{duration:s=300,easing:r=y,disableOnFinish:n=!0}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,this._motion=new S({duration:s,range:Me,easing:r}),this._disableOnFinish=n,this.changeStartEnd(t,i)}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}get animating(){return this._motion.activated}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}changeStartEnd(e,t){e=e.clone(),t=t.clone(),e.yaw=u(e.yaw,0,360),t.yaw=u(t.yaw,0,360),180<Math.abs(t.yaw-e.yaw)&&(t.yaw=t.yaw<e.yaw?t.yaw+360:t.yaw-360),this._from=e,this._to=t}update(e){var t,i,s,r;this._enabled&&(t=this._view3D.camera,i=this._from,s=this._to,(r=this._motion).update(e),e=r.val,t.yaw=H(i.yaw,s.yaw,e),t.pitch=H(i.pitch,s.pitch,e),t.zoom=H(i.zoom,s.zoom,e),t.pivot=i.pivot.clone().lerp(s.pivot,e),1<=e)&&(this._disableOnFinish&&this.disable(),this._finishCallbacks.forEach(e=>e()),this.clearFinished())}enable(){this._enabled||(this._enabled=!0,this.reset())}disable(){this._enabled&&(this._enabled=!1)}reset(){this._motion.reset(0),this._motion.setEndDelta(1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class A{constructor(e,t,i,s=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=i,this.pivot=(new O.Vector3).fromArray(s)}clone(){return new A(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}copy(e){this.yaw=e.yaw,this.pitch=e.pitch,this.zoom=e.zoom,this.pivot.copy(e.pivot)}equals(e){var{yaw:t,pitch:i,zoom:s,pivot:r}=this;return u(t,0,360)===u(e.yaw,0,360)&&i===e.pitch&&s===e.zoom&&r.equals(e.pivot)}}class Ue{constructor(e){this._view3D=e,this._threeCamera=new O.PerspectiveCamera,this._maxTanHalfHFov=0,this._baseFov=45,this._baseDistance=0;var t=P(e.initialZoom)?e.initialZoom:0;this._defaultPose=new A(e.yaw,e.pitch,t),this._currentPose=this._defaultPose.clone(),this._newPose=this._currentPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get newPose(){return this._newPose}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get distance(){return this._view3D.control.zoom.type===_e.FOV?this._baseDistance:this._baseDistance-this._currentPose.zoom}get baseDistance(){return this._baseDistance}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this.distance*Math.tan(_(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._newPose.yaw=e}set pitch(e){this._newPose.pitch=e}set zoom(e){this._newPose.zoom=e}set pivot(e){this._newPose.pivot.copy(e)}set baseFov(e){this._baseFov=e}reset(e=0,t=y,i){var s=this._view3D;const r=s.control,n=s.autoPlayer,a=this._newPose,o=this._currentPose,l=null!=i?i:this._defaultPose;if(e<=0)return a.copy(l),o.copy(l),s.renderer.renderSingleFrame(),r.sync(),Promise.resolve();{const h=n.enabled,c=new Fe(s,o,l);return c.duration=e,c.easing=t,c.enable(),h&&n.disable(),r.add(c),new Promise(e=>{c.onFinished(()=>{a.copy(l),o.copy(l),r.remove(c),r.sync(),h&&n.enableAfterDelay(),e()})})}}resize({width:e,height:t},i=null){var{control:s,fov:r,maintainSize:n}=this._view3D;this._threeCamera.aspect=e/t,r===$?n&&null!=i?(e=t/i.height,n=this._currentPose.zoom,t=Math.tan(_((this._baseFov-n)/2)),this._baseFov=p(2*Math.atan(e*t))+n):this._applyEffectiveFov(45):this._baseFov=r,s.zoom.updateRange()}fit(e){var t=this._view3D,i=this._threeCamera,s=this._defaultPose,r=t.control,n=t.pivot,a=e.bbox,o=t.fov,l=o===$?45:o;const h=e.center;var c=t.ignoreCenterOnFit||t.center===$?(new O.Vector3).subVectors(a.max,a.min).lengthSq()/4:e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(h)),0),c=Math.sqrt(c);const d=c/Math.sin(_(l/2));var u=e.reduceVertices((e,t)=>{var t=(new O.Vector3).subVectors(t,h),i=Math.hypot(t.x,t.z);return Math.max(e,i/(d-Math.abs(t.y)))},0);o===$?(this._maxTanHalfHFov=u,this._applyEffectiveFov(l)):this._maxTanHalfHFov=o,s.pivot=n===$?h.clone():oe(n,a),this._baseDistance=d,i.near=.1*(d-c),i.far=10*(d+c),r.zoom.updateRange(),P(t.initialZoom)?s.zoom=t.initialZoom:(u=this._baseFov,l=e.bbox,o=t.initialZoom.axis,n=t.initialZoom.ratio,c=(a=(new O.Vector3).subVectors(l.max,l.min))[o],r="y"===o?c/n:c/(n*i.aspect),e="z"!==o?d-a.z/2:d-a.x/2,t=p(2*Math.atan(r/(2*e))),s.zoom=u-t)}updatePosition(){var e=this._view3D,t=e.control,i=this._threeCamera,s=this._currentPose,r=this._newPose,n=this._baseFov,a=this._baseDistance,t=t.zoom.type===_e.FOV,o=s.clone(),n=(s.yaw=u(r.yaw,0,360),s.pitch=d(r.pitch,De.min,De.max),s.zoom=r.zoom,s.pivot.copy(r.pivot),t?n-s.zoom:n),t=t?a:a-s.zoom,a=j(t,s.yaw,s.pitch);a.add(s.pivot),i.fov=n,i.position.copy(a),i.lookAt(s.pivot),i.updateProjectionMatrix(),r.copy(s),e.trigger(f.CAMERA_CHANGE,{type:f.CAMERA_CHANGE,target:e,pose:s.clone(),prevPose:o})}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(_(e/2)),e=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=p(2*Math.atan(e))}_parseBboxRatioOption(e,t){const s=t.min.toArray(),r=(new O.Vector3).subVectors(t.max,t.min).toArray();return e.map((e,t)=>{var i;return n(e)?(i=.01*parseFloat(e),s[t]+i*r[t]):e})}}class Be{constructor(e){this._onResize=()=>{this._view3d.resize()},this._skipFirstResize=(()=>{let e=!0;return()=>{e?e=!1:this._onResize()}})(),this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){var e,t,i=this._view3d;return this._enabled&&this.disable(),i.useResizeObserver&&window.ResizeObserver?(t=0!==(t=(e=i.renderer.canvas).getBoundingClientRect()).width||0!==t.height,(t=new ResizeObserver(t?this._skipFirstResize:this._onResize)).observe(e),this._resizeObserver=t):(i.resize(),window.addEventListener(m.RESIZE,this._onResize)),this._enabled=!0,this}disable(){var e;return this._enabled&&((e=this._resizeObserver)?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(m.RESIZE,this._onResize),this._enabled=!1),this}}class ke{constructor(e){this._onAnimationLoop=t=>{var e=this._view3D,i=this._actions,s=this._clips,i=i.findIndex(e=>e===t.action);e.trigger(f.ANIMATION_LOOP,{type:f.ANIMATION_LOOP,target:e,index:i,action:t.action,clip:s[i]}),e.animationRepeatMode===me.ALL&&(e=i+1>=s.length?0:i+1,this.play(e))},this._onAnimationFinished=t=>{var e=this._view3D,i=this._actions,s=this._clips,i=i.findIndex(e=>e===t.action);e.trigger(f.ANIMATION_FINISHED,{type:f.ANIMATION_FINISHED,target:e,index:i,action:t.action,clip:s[i]})},this._view3D=e,this._mixer=new O.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._timeScale=1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!=(e=this._clips[this._activeAnimationIdx])?e:null}get activeAction(){var e;return null!=(e=this._actions[this._activeAnimationIdx])?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}get animating(){var e;return(null==(e=this.activeAction)?void 0:e.isRunning())&&!this.paused}get timeScale(){return this._timeScale}set timeScale(e){this._timeScale=e}init(){this._mixer.addEventListener("loop",this._onAnimationLoop),this._mixer.addEventListener("finished",this._onAnimationFinished)}destroy(){this.reset(),this._mixer.removeEventListener("loop",this._onAnimationLoop),this._mixer.removeEventListener("finished",this._onAnimationFinished)}setClips(e){const t=this._mixer;this._clips=e,this._actions=e.map(e=>{e=t.clipAction(e);return e.setEffectiveWeight(0),e}),this.updateRepeatMode()}play(e){var t=this._view3D,i=this._actions[e];i&&(this.stop(),this._restoreTimeScale(),i.setEffectiveTimeScale(1),i.setEffectiveWeight(1),i.play(),this._activeAnimationIdx=e,this._flushFadePromises(),t.trigger(f.ANIMATION_START,{type:f.ANIMATION_START,target:t,index:e,action:i,clip:this._clips[e]}))}crossFade(h,c,{synchronize:d=!1}={}){var u;return Q(this,void 0,void 0,function*(){const i=this._view3D,t=this._mixer;var e=this._actions,s=this._activeAnimationIdx;const r=e[h],n=null!=(u=e[s])?u:r,a="loop",o=(this._restoreTimeScale(),()=>{r.enabled=!0,r.setEffectiveTimeScale(1),r.setEffectiveWeight(1),r.time=0,r.play(),n.crossFadeTo(r,c/1e3,!0),this._activeAnimationIdx=h});if(d){const l=e=>{e.action===n&&(t.removeEventListener(a,l),o())};t.addEventListener(a,l)}else o();return this._flushFadePromises(),new Promise(e=>{const t=()=>{r.getEffectiveWeight()<1||(i.off(f.BEFORE_RENDER,t),e(!0))};i.on(f.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return Q(this,void 0,void 0,function*(){const i=this._view3D;const s=this._actions[this._activeAnimationIdx];return!!s&&(this._flushFadePromises(),this._restoreTimeScale(),s.fadeOut(e/1e3),new Promise(e=>{const t=()=>{0<s.getEffectiveWeight()||(i.off(f.BEFORE_RENDER,t),this._activeAnimationIdx=-1,e(!0))};i.on(f.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._view3D.renderer.renderSingleFrame(),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}updateRepeatMode(){var e=this._view3D,t=this._actions;e.animationRepeatMode===me.NONE?t.forEach(e=>{e.clampWhenFinished=!0,e.loop=O.LoopOnce}):t.forEach(e=>{e.clampWhenFinished=!1,e.loop=O.LoopRepeat})}reset(){var e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=this._timeScale}_flushFadePromises(){const i=this._view3D;this._fadePromises.forEach(({resolve:e,listener:t})=>{e(!1),i.off(f.BEFORE_RENDER,t)}),this._fadePromises=[]}}class He extends o{constructor({context:e=window,repeat:t=0,duration:i=300,easing:s=y}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,i=this._repeat,e=this._time+e,s=Math.floor(e/t),e=(this._time=(this._loopCount>=i?d:u)(e,0,t),this._time/t),r={progress:e,easedProgress:this._easing(e)};this.trigger("progress",r);for(let e=0;e<s;e++){if(this._loopCount++,this._loopCount>i)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},r),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=i,this._easing=s,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const Ge={AR:"immersive-ar",VR:"immersive-vr"},Ve={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},L={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend",ESTIMATION_START:"estimationstart",ESTIMATION_END:"estimationend"},ze={TOUCH:"generic-touchscreen"},We={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{},LIGHT_ESTIMATION:{optionalFeatures:["light-estimation"]}},je={},Ke={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class Xe{constructor({scale:e=1}={}){this.rotation=new O.Quaternion,this._axis=new O.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new O.Vector2,this._fromQuat=new O.Quaternion,this._toQuat=new O.Quaternion,this._motion=new S({range:Ie}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:i}){var s,r;this._active&&1===i.length&&(s=this._prevPos,r=this._motion,i=i[0],e=e.modelMovable.getWorldPosition(new O.Vector3),e=(new O.Vector2).fromArray(e.project(t).toArray()),t=z(e,s,i)*this._userScale,e=(new O.Quaternion).setFromAxisAngle(this._axis,t),t=this._getInterpolatedQuaternion(),this._fromQuat.copy(t),this._toQuat.premultiply(e),r.reset(0),r.setEndDelta(1),s.copy(i))}update({scene:e},t){this._active&&(this._motion.update(t),t=this._getInterpolatedQuaternion(),this.rotation.copy(t),e.setModelRotation(t))}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,i=this._fromQuat,e=e.val;return(new O.Quaternion).copy(i).slerp(t,e)}}(t=w=w||{})[t.WAITING=0]="WAITING",t[t.TRANSLATING=1]="TRANSLATING",t[t.BOUNCING=2]="BOUNCING";class qe{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:i=de.EASE_OUT_BOUNCE}={}){this._hoverPosition=new O.Vector3,this._floorPosition=new O.Vector3,this._wallRotation=new O.Quaternion,this._dragPlane=new O.Plane,this._enabled=!1,this._vertical=!1,this._state=w.WAITING,this._initialPos=new O.Vector2,this._hoverHeight=e,this._bounceMotion=new S({duration:t,easing:i,range:Ie})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){this._enabled&&(this._dragPlane.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=w.TRANSLATING)}deactivate(){var e,t,i;!this._enabled||this._vertical||this._state===w.WAITING?this._state=w.WAITING:(this._state=w.BOUNCING,e=this._floorPosition,i=this._hoverPosition,t=this._bounceMotion,i=i.y-e.y,t.reset(i),t.setEndDelta(-i))}init(e,t,i){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=i?new O.Vector3(0,1,0).applyQuaternion(t):new O.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=i}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:i},{hitResults:s}){var r=this._state,r=r===w.WAITING||r===w.BOUNCING;if(s&&1===s.length&&!r){var r=s[0],s=this._floorPosition.clone(),n=this._floorPosition,a=this._hoverPosition,o=this._hoverHeight,l=this._dragPlane,h=this._vertical,c=r.results[0]&&r.results[0].getPose(t),d=c&&(new O.Matrix4).fromArray(c.transform.matrix),u=c&&.75<d.elements[5],_=c&&d.elements[5]<.25,i=(new O.Vector3).setFromMatrixPosition(i.matrixWorld),d=c&&(new O.Vector3).setFromMatrixPosition(d);if(h){if(e&&(!c||!_))return(h=e.getPose(r.inputSource.targetRaySpace,t))?(_=h.transform.position,h=new O.Vector3(_.x,_.y,_.z).sub(i).normalize(),void((_=new O.Ray(i,h).intersectPlane(l,new O.Vector3))&&n.copy(_))):void 0;var h=new O.Vector3(0,1,0),_=c.transform.orientation,_=h.clone().applyQuaternion(new O.Quaternion(_.x,_.y,_.z,_.w)).normalize(),p=(new O.Vector3).crossVectors(new O.Vector3(0,1,0),_),m=new O.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize(),h=(Math.acos(Math.abs(m.dot(_)))>=Math.PI/18&&(m=(new O.Matrix4).makeBasis(p,h,_),(p=new O.Euler(0,0,0,"YXZ").setFromRotationMatrix(m)).z=0,p.x=Math.PI/2,this._wallRotation.setFromEuler(p),l.normal.copy(new O.Vector3(0,1,0).applyQuaternion(this._wallRotation)),l.constant=this._calcDragPlaneConstant(d)),(new O.Vector3).subVectors(d,i).normalize()),_=new O.Ray(i,h).intersectPlane(l,new O.Vector3);_&&n.copy(_)}else{if(e&&(!c||!u))return(m=e.getPose(r.inputSource.targetRaySpace,t))?(p=m.transform.position,h=new O.Vector3(p.x,p.y,p.z).sub(i).normalize(),void((_=new O.Ray(i,h).intersectPlane(l,new O.Vector3))&&(n.copy(_),n.setY(s.y),a.copy(_)))):void 0;c=-l.constant,u=d.y+o,e=(.1<u-c&&(l.constant=-u),(new O.Vector3).subVectors(d,i).normalize()),r=new O.Ray(i,e).intersectPlane(l,new O.Vector3);r&&(n.copy(r),n.setY(d.y),a.copy(r))}}}update({scene:e},t){var i=this._state,s=this._floorPosition,r=this._hoverPosition,n=this._bounceMotion,a=this._vertical;i===w.BOUNCING&&(n.update(t),r.setY(s.y+n.val),1<=n.progress)&&(this._state=w.WAITING),e.setRootPosition(s),a?e.setWallRotation(this._wallRotation):e.setModelHovering(r.y-s.y)}_calcDragPlaneConstant(e){var t=this._vertical,i=this._dragPlane.normal.clone(),i=new O.Plane(i,0),t=t?0:this._hoverHeight;return-(i.distanceToPoint(e)+t)}}class Ye{constructor({width:e=.1,padding:t=20,offset:i=.05,font:s="64px sans-serif",color:r="white"}={}){var n=document.createElement("canvas"),a=n.getContext("2d"),o=(a.font=s,a.measureText("100%")),l=o.actualBoundingBoxLeft+o.actualBoundingBoxRight,o=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent,h=V(l),e=(n.width=h,e*((n.height=h)/l)),h=(this._ctx=a,this._canvas=n,this._height=e*o/l,this._texture=new O.CanvasTexture(n),new O.PlaneGeometry(e,e)),a=new O.Mesh(h,new O.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=s,this._color=r,this._padding=t,this._offset=i,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,i){var s=this._mesh,i=this._height/2+this._offset+i,i=new O.Vector3(0,i,0).applyQuaternion(e.clone().invert());s.position.copy(i),s.lookAt(t)}updateScale(e){var t=this._ctx,i=this._canvas,s=this._padding,r=(100*e).toFixed(0),n=(t.clearRect(0,0,i.width,i.height),i.width/2),i=i.height/2,a=t.measureText(r+"%"),o=(a.actualBoundingBoxLeft+a.actualBoundingBoxRight)/2,a=(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(n-o,i-a-s),t.lineTo(n+o,i-a-s),t.quadraticCurveTo(n+o+s,i-a-s,n+o+s,i-a),t.lineTo(n+o+s,i+a),t.quadraticCurveTo(n+o+s,i+a+s,n+o,i+a+s),t.lineTo(n-o,i+a+s),t.quadraticCurveTo(n-o-s,i+a+s,n-o-s,i+a),t.lineTo(n-o-s,i-a),t.quadraticCurveTo(n-o-s,i-a-s,n-o,i-a-s),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(r+"%",n,i),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class Ze{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new Ye,this._motion=new S({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new Ye}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:i,xrCam:s,initialScale:r}){var n=this._motion,a=n.range;if(r===$){var o=2*Math.atan(1/s.projectionMatrix.elements[5]),l=s.projectionMatrix.elements[0]/s.projectionMatrix.elements[5],s=s.position,h=t.bbox.max.y-t.bbox.min.y,s=s.distanceTo((new O.Vector3).addVectors(i,new O.Vector3(0,h/2,0)))*Math.tan(o/2),i=s*l,h=t.bbox.getBoundingSphere(new O.Sphere),o=s/h.radius,l=i/h.radius;const c=d(Math.min(l,o),a.min,1);n.reset(c)}else n.reset(d(r,a.min,a.max));const c=this._motion.val;this._scaleMultiplier=c,e.setModelScale(c)}setInitialPos(e){this._prevCoordDistance=(new O.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){var i,s;2===t.length&&this._enabled&&this._active&&(i=this._motion,s=(t=(new O.Vector2).subVectors(t[0],t[1]).length())-this._prevCoordDistance,i.setEndDelta(s),this._prevCoordDistance=t,this._updateUIPosition(e))}update({scene:e},t){var i;this._enabled&&this._active&&((i=this._motion).update(t),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier))}_updateUIPosition({view3D:e,scene:t,xrCam:i,vertical:s}){e=e.model,i=(new O.Vector3).setFromMatrixPosition(i.matrixWorld),s=s?e.bbox.getBoundingSphere(new O.Sphere).radius:e.bbox.max.y-e.bbox.min.y;this._ui.updatePosition(t.root.quaternion,i,s)}}class Qe{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:i=1e3}={}){var s=Math.PI/18,r=new O.RingGeometry(.975,1,150,1,-6*s,30*s),s=(r.rotateX(-Math.PI/2),new O.RingGeometry(.96,1.015,30,1,25*s,4*s)),n=s.attributes["position"],a=Math.floor(11*n.count/16),o=Math.floor(13*n.count/16),l=Math.floor((o-a+1)/2),h=(new O.Vector3).fromBufferAttribute(n,a).y;for(let e=a;e<o;e++){var c=e-a,c=.025*(l-Math.abs(c-l));n.setY(e,h-c)}s.rotateX(-Math.PI/2);var d=new O.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),u=new O.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),r=new O.Mesh(r,d),d=new O.Mesh(s,u),s=new O.Group;s.add(r,d),s.position.setY(1e-4),this._mesh=s,this._ring=r,this._arrow=d,this._animator=new S({duration:i}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new O.Sphere).radius)}update({delta:e,rotation:t}){var i,s,r=this._mesh,n=this._animator;r.visible&&(n.update(e),e=this._ring.material,i=this._arrow.material,s=this._opacityRange,e.opacity=n.val*s.min,i.opacity=n.val*s.max,n.val<=0&&(r.visible=!1),r.quaternion.copy(t),r.updateMatrix())}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(t=a=a||{})[t.WAITING=0]="WAITING",t[t.IN_DEADZONE=1]="IN_DEADZONE",t[t.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class $e{constructor({size:e=.1}={}){this._state=a.WAITING,this._detectedGesture=v.NONE,this._testingGestures=v.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new O.Vector2,this._prevTwoFingerPos=new O.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===a.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new O.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new O.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=a.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,v.NONE)}cleanup(){this._testingGestures=v.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=v.NONE,this._state=a.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,i=this._size,s=this._testingGestures,r=this._lastFingerCount,n=e.length;if(t!==a.OUT_OF_DEADZONE){if(this._lastFingerCount=n,this.applyScreenAspect(e),n!==r)return this.setFirstInput(e),v.NONE;1===n?(t=e[0],r=this._prevOneFingerPos.clone(),(t=(new O.Vector2).subVectors(t,r)).length()>i&&(Math.abs(t.x)>Math.abs(t.y)?v.ONE_FINGER_HORIZONTAL&s&&(this._detectedGesture=v.ONE_FINGER_HORIZONTAL):v.ONE_FINGER_VERTICAL&s&&(this._detectedGesture=v.ONE_FINGER_VERTICAL))):2===n&&(r=(new O.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),t=this._prevTwoFingerPos.clone(),(n=(new O.Vector2).subVectors(r,t)).length()>i&&(Math.abs(n.x)>Math.abs(n.y)?v.TWO_FINGER_HORIZONTAL&s&&(this._detectedGesture=v.TWO_FINGER_HORIZONTAL):v.TWO_FINGER_VERTICAL&s&&(this._detectedGesture=v.TWO_FINGER_VERTICAL)),r=(new O.Vector2).subVectors(e[1],e[0]).length(),Math.abs(r-this._initialTwoFingerDistance)>i)&&v.PINCH&s&&(this._detectedGesture=v.PINCH),this._detectedGesture!==v.NONE&&(this._state=a.OUT_OF_DEADZONE)}return this._detectedGesture}}class Je{constructor(e,t,{rotate:i,translate:s,scale:r,ring:n,deadzone:a,initialScale:o}){this._onSelectStart=e=>{var e=e.frame,t=this._view3D,i=this._arScene,s=this._hitTestSource,r=this._deadzoneChecker,n=this._rotateControl,a=this._translateControl,o=this._scaleControl,l=t.renderer.threeRenderer,h=l.xr.getCamera(new O.PerspectiveCamera),l=l.xr.getReferenceSpace();!s||h.cameras.length<=0||(h=h.cameras[0],t=t.model,n.enabled&&r.addTestingGestures(v.ONE_FINGER),a.enabled&&r.addTestingGestures(v.ONE_FINGER),o.enabled&&r.addTestingGestures(v.PINCH),n=e.getHitTestResultsForTransientInput(s),a=this._hitResultToVector(n),r.applyScreenAspect(a),r.setFirstInput(a),1===a.length&&(o=e.getPose(n[0].inputSource.targetRaySpace,l))&&(s=(new O.Vector3).setFromMatrixPosition(h.matrixWorld),r=o.transform.position,a=new O.Vector3(r.x,r.y,r.z).sub(s).normalize(),e=new O.Ray(s,a),(n=t.bbox.getBoundingSphere(new O.Sphere)).applyMatrix4(i.modelMovable.matrixWorld),e.intersectSphere(n,new O.Vector3))&&(this._modelHit=!0),this._vertical&&!this._modelHit)||this._floorIndicator.show()},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=i,this._translate=s,this._scale=r,this._initialScale=o,this._rotateControl=new Xe(Z(i)),this._translateControl=new qe(Z(s)),this._scaleControl=new Ze(Z(r)),this._floorIndicator=new Qe(n),this._deadzoneChecker=new $e(a)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:n,session:a,size:o,vertical:l,hitPosition:h,hitRotation:c}){return Q(this,void 0,void 0,function*(){var e=this._arScene,t=this._translateControl,i=this._scaleControl,s=this._floorIndicator,r=this._deadzoneChecker,t=(this._vertical=l,t.init(h,c,l),r.setAspect(o.height/o.width),e.add(s.mesh,i.ui.mesh),this.syncTargetModel(n),yield a.requestHitTestSourceForTransientInput({profile:ze.TOUCH}));this._hitTestSource=t,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(L.SELECT_START,this._onSelectStart),e.removeEventListener(L.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,i=this._translate,s=this._scale,r=this._rotateControl,n=this._translateControl,a=this._scaleControl,o=this._vertical;e.addEventListener(L.SELECT_START,this._onSelectStart),e.addEventListener(L.SELECT_END,this._onSelectEnd),t&&!o&&r.enable(),i&&n.enable(),s&&a.enable()}disable(e){var t=this._rotateControl,i=this._translateControl,s=this._scaleControl;e.removeEventListener(L.SELECT_START,this._onSelectStart),e.removeEventListener(L.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),i.disable(),s.disable()}update(e){var{view3D:t,session:i,frame:s}=e,r=this._hitTestSource;r&&t.model&&(t=this._deadzoneChecker,i=i.inputSources,r=null!=(s=null==s?void 0:s.getHitTestResultsForTransientInput(r))?s:[],s={coords:this._hitResultToVector(r),inputSources:i,hitResults:r},t.inDeadzone?this._checkDeadzone(e,s):this._processInput(e,s),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,i=this._translateControl.floorPosition,s=this._view3D.renderer.threeRenderer.xr.getCamera(new O.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:i,xrCam:s,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var i=this._arScene,s=this._rotateControl,r=this._translateControl,n=this._scaleControl,a=this._deadzoneChecker.check(t.map(e=>e.clone()));if(a!==v.NONE)switch(a){case v.ONE_FINGER_HORIZONTAL:case v.ONE_FINGER_VERTICAL:(this._modelHit?(r.activate(),r):(s.activate(),s.updateRotation(i.modelMovable.quaternion),s)).setInitialPos(t);break;case v.PINCH:n.activate(e),n.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"],i=this._arScene,s=this._rotateControl,r=this._translateControl,n=this._scaleControl,a=this._floorIndicator,t=1e3*t,n=(s.update(e,t),r.update(e,t),n.update(e,t),s.rotation),e=r.floorPosition;i.setRootPosition(e),a.update({delta:t,rotation:n})}_hitResultToVector(e){return e.map(e=>(new O.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class et{constructor(){this._root=new O.Scene,this._modelRoot=new O.Group,this._modelMovable=new O.Group,this._modelFixed=new O.Group,this._arRoot=new O.Group;var e=this._root,t=this._modelRoot,i=this._modelMovable,s=this._modelFixed,r=this._arRoot;t.add(i),e.add(t,s,r)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){var t=this._root,i=this._modelMovable,s=this._modelFixed,e=e.scene;i.add(e.userObjects,e.envObjects),s.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,i=this._modelFixed;const s=e.scene;[...t.children,...i.children].forEach(e=>{s.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}remove(...e){this._arRoot.remove(...e)}setRootPosition(e){this._root.position.copy(e)}setWallRotation(e){this._root.quaternion.copy(e)}updateModelRootPosition(e,t){var i=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,i.position.setZ(t/2),i.position.setY(-e.bbox.min.z),i.rotateX(-Math.PI/2),i.updateMatrix())}setModelHovering(e){this._modelMovable.position.setY(e)}setModelRotation(e){this._modelMovable.quaternion.copy(e)}setModelScale(e){this._root.scale.setScalar(e)}}class tt{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,We.DOM_OVERLAY(e)}}class it{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(Ve.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return We.HIT_TEST}getResults(e){return null!=(e=null==e?void 0:e.getHitTestResults(this._source))?e:[]}}class st{constructor(e,t,i,s,r){this.xrLight=e,this.renderer=t,this.lightProbe=i,this.xrWebGLBinding=null,this.estimationStartCallback=r,this.frameCallback=this.onXRFrame.bind(this);i=t.xr.getSession();if(s&&"XRWebGLBinding"in window){var r=new O.WebGLCubeRenderTarget(16),n=(e.environment=r.texture,t.getContext());switch(i.preferredReflectionFormat){case"srgba8":n.getExtension("EXT_sRGB");break;case"rgba16f":n.getExtension("OES_texture_half_float")}this.xrWebGLBinding=new XRWebGLBinding(i,n),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}i.requestAnimationFrame(this.frameCallback)}updateReflection(){var e,t=this.renderer.properties.get(this.xrLight.environment);t&&(e=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe))&&(t.__webglTexture=e)}onXRFrame(e,t){var i;this.xrLight&&(t.session.requestAnimationFrame(this.frameCallback),t=t.getLightEstimate(this.lightProbe))&&(this.xrLight.lightProbe.sh.fromArray(t.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1,i=Math.max(1,Math.max(t.primaryLightIntensity.x,Math.max(t.primaryLightIntensity.y,t.primaryLightIntensity.z))),this.xrLight.directionalLight.color.setRGB(t.primaryLightIntensity.x/i,t.primaryLightIntensity.y/i,t.primaryLightIntensity.z/i),this.xrLight.directionalLight.intensity=i,this.xrLight.directionalLight.position.copy(t.primaryLightDirection),this.estimationStartCallback)&&(this.estimationStartCallback(),this.estimationStartCallback=null)}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class rt extends O.Group{constructor(t,i=!0){super(),this.lightProbe=new O.LightProbe,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new O.DirectionalLight,this.directionalLight.intensity=0,this.add(this.directionalLight);let s=this.environment=null,r=!1;t.xr.addEventListener("sessionstart",()=>{var e=t.xr.getSession();"requestLightProbe"in e&&e.requestLightProbe({reflectionFormat:e.preferredReflectionFormat}).then(e=>{s=new st(this,t,e,i,()=>{r=!0,this.dispatchEvent({type:"estimationstart"})})})}),t.xr.addEventListener("sessionend",()=>{s&&(s.dispose(),s=null),r&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{s&&(s.dispose(),s=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}class nt{constructor(e,t){this._onEstimationStart=()=>{var e=this._light,t=this._arScene;e&&(t.add(e),e.environment)&&(t.root.environment=e.environment)},this._onEstimationEnd=()=>{var e=this._light,t=this._arScene;e&&(t.remove(e),t.root.environment=this._origEnvironment)},this._view3D=e,this._arScene=t,this._light=null,this._origEnvironment=null}static isAvailable(){return!0}getFeatures(){return We.LIGHT_ESTIMATION}init(){var e=this._view3D.renderer.threeRenderer,e=new rt(e);(this._light=e).addEventListener(L.ESTIMATION_START,this._onEstimationStart),e.addEventListener(L.ESTIMATION_END,this._onEstimationEnd)}destroy(){var e=this._light;e&&(e.removeEventListener(L.ESTIMATION_START,this._onEstimationStart),e.removeEventListener(L.ESTIMATION_END,this._onEstimationEnd),this._light=null)}}class at{constructor(e,{features:t=je,vertical:i=!1,overlayRoot:s=null,useLightEstimation:r=!0,rotate:n=!0,translate:a=!0,scale:o=!0,ring:l={},deadzone:h={},initialScale:c=$}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=i,this.overlayRoot=s,this.useLightEstimation=r,this._arScene=new et,this._control=new Je(e,this._arScene,{rotate:n,translate:a,scale:o,ring:l,deadzone:h,initialScale:c}),this._hitTest=new it,this._domOverlay=new tt,this._lightEstimation=new nt(e,this._arScene)}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&it.isAvailable()&&tt.isAvailable()?navigator.xr.isSessionSupported(Ge.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}get lightEstimation(){return this._lightEstimation}enter(){return Q(this,void 0,void 0,function*(){const o=this._view3D,l=o.scene,h=this._arScene,e=o.renderer,c=e.threeRenderer,d=this._control;var t=this._hitTest;const i=this._domOverlay;var s=this.useLightEstimation;const r=this._lightEstimation,u=this.vertical;var n=this._getAllXRFeatures();c.xr.enabled=!0,s&&r.init();const _=yield navigator.xr.requestSession(Ge.AR,n),a=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(Ve.LOCAL),yield c.xr.setSession(_),h.init(o),t.init(_);_.addEventListener("end",()=>Q(this,void 0,void 0,function*(){d.destroy(_),h.destroy(o),r.destroy(),i.destroy(),c.setPixelRatio(a),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),o.trigger(f.AR_END,{target:o,type:f.AR_END,session:this})}),{once:!0});const p=new O.Vector2(window.outerWidth,window.outerHeight),m=new O.Clock;m.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var i,s,r,n=c.xr.getCamera(new O.PerspectiveCamera),a=m.getDelta();n.cameras.length<=0||(n=n.cameras[0],i=c.xr.getReferenceSpace(),s={width:null!=(r=null==(s=_.renderState.baseLayer)?void 0:s.framebufferWidth)?r:1,height:null!=(r=null==s?void 0:s.framebufferHeight)?r:1},r={view3D:o,scene:h,session:_,delta:a,frame:t,vertical:u,referenceSpace:i,xrCam:n,size:s},t=1e3*a,o.trigger(f.BEFORE_RENDER,{type:f.BEFORE_RENDER,target:o,delta:t}),this._modelPlaced?(o.animator.update(a),d.update(r),l.shadowPlane.render(),c.render(h.root,n),o.annotation.render(n,p)):this._initModelPosition(r),o.trigger(f.RENDER,{type:f.RENDER,target:o,delta:t}))}),o.trigger(f.AR_START,{type:f.AR_START,target:o,session:this})})}exit(){return Q(this,void 0,void 0,function*(){var e=this._view3D.renderer.threeRenderer.xr.getSession();return null==e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!=(t=F(this.overlayRoot))?t:this._createARRootElement();return G({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),this._lightEstimation.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:i,size:s,vertical:r,referenceSpace:n}=e;var e=this._view3D,a=e.model;const o=this._arScene;var l=this._hitTest;if(l.ready&&a){const p=this._control;var h=l.getResults(t);if(!(h.length<=0)){h=h[0].getPose(n);if(h){var c=(new O.Matrix4).fromArray(h.transform.matrix);if(!(!r&&c.elements[5]<.75||r&&(.25<=c.elements[5]||c.elements[5]<=-.25))){var d,u,c=(new O.Vector3).setFromMatrixPosition(c),_=new O.Quaternion;r&&(u=new O.Vector3(0,1,0),h=h.transform.orientation,h=u.clone().applyQuaternion(new O.Quaternion(h.x,h.y,h.z,h.w)).normalize(),d=(new O.Vector3).crossVectors(new O.Vector3(0,1,0),h),d=(new O.Matrix4).makeBasis(d,u,h),(u=new O.Euler(0,0,0,"YXZ").setFromRotationMatrix(d)).z=0,u.x=Math.PI/2,_.setFromEuler(u),o.setWallRotation(_)),o.updateModelRootPosition(a,r),o.setRootPosition(c),o.showModel(),l.destroy(),this._modelPlaced=!0,e.trigger(f.AR_MODEL_PLACED,{type:f.AR_MODEL_PLACED,target:e,session:this,model:a}),p.init({model:a,vertical:r,session:i,size:s,hitPosition:c,hitRotation:_});const m=p.scale.scale;h=new He({context:i,duration:1e3});h.on("progress",e=>{o.setModelScale(e.easedProgress*m)}),h.on("finish",()=>{o.setModelScale(m),p.enable(i)}),h.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement(E);return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(f.AR_END,()=>{e.rootEl.removeChild(t)}),t}}at.type=e.WEBXR;class ot{constructor(e,t={}){var{file:i=null,mode:s=pe.ONLY_AR,fallbackURL:r=null,title:n=null,link:a=null,sound:o=null,resizable:l=!0,vertical:h=!1,disableOcclusion:c=!1,initialScale:d=$,shareText:u=null}=t,t=le(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=i,this.fallbackURL=r,this.mode=s,this.title=n,this.link=a,this.sound=o,this.resizable=l,this.vertical=h,this.disableOcclusion=c,this.initialScale=d,this.shareText=u,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var s;return Q(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=W(this.resizable),t.enable_vertical_placement=W(this.vertical),t.disable_occlusion=W(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var i=null!=(s=this.file)?s:e.src;if(!i)return Promise.reject(new l(c.FILE_NOT_SUPPORTED(null!=(s=this.file)?s:e.src),h.FILE_NOT_SUPPORTED));t.file=new URL(i,window.location.href).href;e=this.fallbackURL,i=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),e=t.mode===pe.ONLY_AR?Ke.INTENT_AR_CORE(i,e):Ke.INTENT_SEARCHBOX(i,e||Ke.FALLBACK_DEFAULT(i)),i=document.createElement("a");i.href=e,i.click()})}exit(){return Promise.resolve()}}ot.type=e.SCENE_VIEWER;class lt{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:i=null,applePayButtonType:s=null,callToAction:r=null,checkoutTitle:n=null,checkoutSubtitle:a=null,price:o=null,custom:l=null,customHeight:h=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=i,this.applePayButtonType=s,this.callToAction=r,this.checkoutTitle=n,this.checkoutSubtitle=a,this.price=o,this.custom=l,this.customHeight=h}static isAvailable(){return Promise.resolve((e=document.createElement("a")).relList&&e.relList.supports&&e.relList.supports("ar")&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints));var e}enter(){const t=this._view3D;var e,i,s,r,n,a,o=t.iosSrc;return o?(e=this.canonicalWebPageURL,i=this.custom,s=window.location.href,(r=document.createElement("a")).setAttribute("rel","ar"),r.appendChild(document.createElement("img")),n=Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,i])=>(i&&(e[t]=i),e),{}),a=new URL(o,s),this.allowsContentScaling||(n.allowsContentScaling="0"),e&&(n.canonicalWebPageURL=new URL(e,s).href),i&&(n.custom=new URL(i,s).href),a.hash=new URLSearchParams(n).toString(),r.setAttribute("href",a.href),r.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(f.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:f.QUICK_LOOK_TAP,target:t}))},!1),r.click(),Promise.resolve()):Promise.reject(new l(c.FILE_NOT_SUPPORTED(""+o),h.FILE_NOT_SUPPORTED))}exit(){return Promise.resolve()}}lt.type=e.QUICK_LOOK;const ht={[e.WEBXR]:at,[e.SCENE_VIEWER]:ot,[e.QUICK_LOOK]:lt};class ct{constructor(e){this._view3D=e,this._activeSession=null,e.on(f.AR_START,({session:e})=>{this._activeSession=e}),e.on(f.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return Q(this,void 0,void 0,function*(){var e=this._getSesssionClasses();return(yield Promise.all(e.map(e=>e.isAvailable()))).some(e=>!0===e)})}enter(){return Q(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new l(c.NOT_INITIALIZED,h.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable())return yield new t(e,Z(e[t.type])).enter(),Promise.resolve()}catch(e){}return Promise.reject()})}exit(){return Q(this,void 0,void 0,function*(){var e=this._activeSession;null!=e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>ht[e])}_getUsingSessionTypes(){const t=this._view3D;return t.arPriority.filter(e=>!!t[e])}}class dt{constructor(e,{element:t=null,focus:i=[],focusDuration:s=1e3,focusOffset:r=[],baseFov:n=45,baseDistance:a=null}={}){this._onClick=()=>{this.focus()},this._onWheel=e=>{e.preventDefault(),e.stopPropagation()},this._view3D=e,this._element=t,this._focus=i,this._focusDuration=s,this._focusOffset=r,this._baseFov=n,this._baseDistance=a,this._enabled=!1,this._hidden=!1,this._focusing=!1,this._tooltipSize=new O.Vector2,t&&(t.draggable=!1,this.resize())}get element(){return this._element}get renderable(){return!!this._element}get focusing(){return this._focusing}get focusPose(){return this._focus}get focusDuration(){return this._focusDuration}get focusOffset(){return this._focusOffset}get baseFov(){return this._baseFov}get baseDistance(){return this._baseDistance}get hidden(){return this._hidden}set focusDuration(e){this._focusDuration=e}set baseFov(e){this._baseFov=e}set baseDistance(e){this._baseDistance=e}destroy(){var e=this._view3D.annotation.wrapper,t=this._element;this.disableEvents(),t&&t.parentElement===e&&e.removeChild(t)}resize(){var e=this._element;e&&(e=e.querySelector("."+J.ANNOTATION_TOOLTIP))&&this._tooltipSize.set(e.offsetWidth,e.offsetHeight)}render({screenPos:e,screenSize:t,renderOrder:i}){var s=this._element,r=this._tooltipSize;s&&!this._hidden&&(s.style.zIndex=""+(i+1),s.style.transform=`translate(-50%, -50%) translate(${e.x}px, ${e.y}px)`,e.y+r.y>t.y?s.classList.add(J.ANNOTATION_FLIP_Y):s.classList.remove(J.ANNOTATION_FLIP_Y),e.x+r.x>t.x?s.classList.add(J.ANNOTATION_FLIP_X):s.classList.remove(J.ANNOTATION_FLIP_X))}show(){var e=this._element;this._hidden=!1,e&&e.classList.remove(J.ANNOTATION_HIDDEN)}hide(){var e=this._element;this._hidden=!0,e&&e.classList.add(J.ANNOTATION_HIDDEN)}setOpacity(e){var t=this._element;t&&(t.style.opacity=""+e)}enableEvents(){var e=this._element;e&&!this._enabled&&(e.addEventListener(m.CLICK,this._onClick),e.addEventListener(m.WHEEL,this._onWheel),this._enabled=!0)}disableEvents(){var e=this._element;e&&this._enabled&&(e.removeEventListener(m.CLICK,this._onClick),e.removeEventListener(m.WHEEL,this._onWheel),this._enabled=!1)}handleUserInput(){this._focusing&&this._view3D.annotationAutoUnfocus&&this.unfocus()}_getFocus(){var e=this._view3D,t=(new O.Vector3).fromArray(this._focus),i=e.camera.baseDistance,s=this._baseFov,r=(null!=(r=this._baseDistance)?r:i)*Math.tan(_((s-t.z)/2)),s=2*p(Math.atan(r/i));return t.z=e.camera.baseFov-s,t}_getPivotOffset(){var e,t=this._focusOffset;return new O.Vector3(null!=(e=t[0])?e:0,null!=(e=t[1])?e:0,null!=(e=t[2])?e:0)}_onFocus(){var e=this._view3D,t=this._element;e.annotation.list.forEach(e=>{e._focusing&&e.unfocus()}),t&&t.classList.add(J.ANNOTATION_SELECTED),this._focusing=!0,e.trigger(f.ANNOTATION_FOCUS,{type:f.ANNOTATION_FOCUS,target:e,annotation:this})}_onUnfocus(){var e=this._view3D,t=this._element;t&&t.classList.remove(J.ANNOTATION_SELECTED),this._focusing=!1,e.trigger(f.ANNOTATION_UNFOCUS,{type:f.ANNOTATION_UNFOCUS,target:e,annotation:this})}}class ut extends dt{constructor(e,t={}){var{position:i=[]}=t;super(e,le(t,["position"])),this._position=(new O.Vector3).fromArray(i)}get position(){return this._position}focus(){return Q(this,void 0,void 0,function*(){if(!this._focusing){var t=this._view3D["camera"],i=this._focus;let e;var s,r=this._getPivotOffset(),r=(new O.Vector3).addVectors(this._position,r);return e=0<i.length?(i=this._getFocus(),new A(i.x,i.y,i.z,r.toArray())):(i=this._calculateNormalFromModelCenter(),{yaw:i,pitch:s}=K(i),new A(p(i),p(s),0,r.toArray())),window.addEventListener(m.CLICK,()=>{this.unfocus()},{once:!0,capture:!0}),this._onFocus(),e.equals(t.currentPose)?Promise.resolve():t.reset(this._focusDuration,y,e)}})}unfocus(){this._focusing&&this._onUnfocus()}toJSON(){return{position:this._position.toArray(),focus:this._focus,duration:this._focusDuration,focusOffset:this._focusOffset}}_calculateNormalFromModelCenter(){var e=this._view3D.model,e=e?e.bbox.getCenter(new O.Vector3):new O.Vector3;return(new O.Vector3).subVectors(this._position,e).normalize()}}class _t extends dt{constructor(e,t={}){var{meshIndex:i=-1,faceIndex:s=-1,weights:r=k(3).map(()=>1/3)}=t;super(e,le(t,["meshIndex","faceIndex","weights"])),this._meshIndex=i,this._faceIndex=s,this._weights=r,this._trackingControl=null}get position(){return this._getPosition()}get renderable(){return!!this._element&&0<=this._meshIndex&&0<=this._faceIndex}get meshIndex(){return this._meshIndex}get faceIndex(){return this._faceIndex}get weights(){return this._weights}focus(){return Q(this,void 0,void 0,function*(){var e,t,i,s,r;this._focusing||({camera:t,control:i}=e=this._view3D,s=this._getFocus(),r=this._getFocusPivot(),s=new A(s.x,s.y,s.z,r.toArray()),r=new Fe(e,t.currentPose,s,{duration:this._focusDuration,disableOnFinish:!1}),(this._trackingControl=r).enable(),i.add(r),this._onFocus())})}unfocus(){this._focusing&&(this.destroyTrackingControl(),this._onUnfocus())}render(e){super.render(e);var t,i,s,e=this._trackingControl;e&&(t=this._view3D["camera"],s=this._getFocus(),i=this._getFocusPivot(),s=new A(s.x,s.y,s.z,i.toArray()),e.changeStartEnd(t.currentPose,s),e.reset())}handleUserInput(){this._focusing&&(this._view3D.annotationAutoUnfocus?this.unfocus():this.destroyTrackingControl())}toJSON(){return{meshIndex:this._meshIndex,faceIndex:this._faceIndex,focus:this._focus,duration:this._focusDuration,focusOffset:this._focusOffset}}destroyTrackingControl(){var e=this._view3D["control"],t=this._trackingControl;t&&(e.sync(),e.remove(t),t.destroy(),this._trackingControl=null)}_getPosition(){var e=this._view3D.model,t=this._meshIndex,i=this._faceIndex,s=this._weights,e=re(e,t,i);return e?(new O.Vector3).addScaledVector(e[0],s[0]).addScaledVector(e[1],s[1]).addScaledVector(e[2],s[2]):new O.Vector3}_getFocusPivot(){var e=this._getPosition(),t=this._getPivotOffset();return(new O.Vector3).addVectors(e,t)}}class pt{constructor(e){this._onInput=()=>{this._list.forEach(e=>{e.handleUserInput()})},this._view3D=e,this._list=[],this._wrapper=F(e.annotationWrapper,e.rootEl)||this._createWrapper()}get list(){return this._list}get wrapper(){return this._wrapper}init(){this._view3D.control.controls.forEach(e=>{e.on({[T.HOLD]:this._onInput})})}destroy(){this._view3D.control.controls.forEach(e=>{e.off({[T.HOLD]:this._onInput})}),this.reset()}resize(){this._list.forEach(e=>{e.resize()})}collect(){const r=this._view3D;var e=this._wrapper,e=[].slice.apply(e.querySelectorAll(r.annotationSelector)).map(e=>{var t,i,s=e.dataset.focus,s={element:e,focus:s?s.split(" ").map(e=>parseFloat(e)):[],focusDuration:e.dataset.duration?parseFloat(e.dataset.duration):void 0};return e.dataset.meshIndex?(t=parseFloat(e.dataset.meshIndex),i=e.dataset.faceIndex?parseFloat(e.dataset.faceIndex):void 0,new _t(r,Object.assign(Object.assign({},s),{meshIndex:t,faceIndex:i}))):(i=(t=e.dataset.position)?t.split(" ").map(e=>parseFloat(e)):[],new ut(r,Object.assign(Object.assign({},s),{position:i})))});this.add(...e)}load(e){const s=new O.FileLoader;return new Promise((t,i)=>{s.load(e,e=>{e=JSON.parse(e),e=this.parse(e);this.add(...e),t(e)},void 0,e=>{i(e)})})}parse(e){const n=this._view3D,{baseFov:a,baseDistance:o,items:t}=e;return t.map(e=>{var{meshIndex:t,faceIndex:i,position:s}=e,r=le(e,["meshIndex","faceIndex","position"]),e=this._createDefaultAnnotationElement(e.label);return null!=t&&null!=i?new _t(n,Object.assign(Object.assign({meshIndex:t,faceIndex:i},r),{baseFov:a,baseDistance:o,element:e})):new ut(n,Object.assign(Object.assign({position:s},r),{baseFov:a,baseDistance:o,element:e}))})}render(e,t){var i=this._view3D,s=i.model;if(s){const o=null!=t?t:i.renderer.canvasSize,l=o.clone().multiplyScalar(.5),h=null!=e?e:i.camera.threeCamera,r=h.position,c=s.center,d=i.annotationBreakpoints;t=[...this._list].filter(e=>e.renderable).map(e=>{var t=e.position;return{annotation:e,position:t,distToCameraSquared:r.distanceToSquared(t)}}).sort((e,t)=>t.distToCameraSquared-e.distToCameraSquared);const u=(new O.Vector3).subVectors(r,c).normalize(),_=Object.keys(d).map(e=>parseFloat(e)).sort((e,t)=>t-e);t.forEach(({annotation:e,position:t},i)=>{if(e.element){var s=t.clone().project(h),s=new O.Vector2(s.x,-s.y),r=(new O.Vector3).subVectors(t,c).normalize(),n=p(Math.abs(Math.acos(r.dot(u))));s.multiply(l),s.add(l);for(const a of _)if(n>=a){e.setOpacity(d[a]);break}e.render({position:t,renderOrder:i,screenPos:s,screenSize:o})}})}}add(...e){const t=this._wrapper;e.forEach(e=>{e.enableEvents(),e.element&&e.element.parentElement!==t&&t.appendChild(e.element)}),this._list.push(...e)}remove(e){e=this._list.splice(e,1)[0];return e?(e.destroy(),e):null}reset(){var e=this._list;e.splice(0,e.length).forEach(e=>{e.destroy()})}toJSON(){var e=this._view3D,t=this._list.map(e=>{return Object.assign(Object.assign({},e.toJSON()),{label:(null==(e=null==(e=e.element)?void 0:e.querySelector("."+J.ANNOTATION_TOOLTIP))?void 0:e.innerHTML)||null})}),i=e.renderer.size,i=Math.max(i.height/i.width,1);return{baseFov:e.camera.baseFov,baseDistance:e.camera.baseDistance,aspect:i,items:t}}_createWrapper(){var e=this._view3D,t=document.createElement(E);return t.classList.add(J.ANNOTATION_WRAPPER),e.rootEl.appendChild(t),t}_createDefaultAnnotationElement(e){var t,i=document.createElement(E);return i.classList.add(J.ANNOTATION),i.classList.add(J.ANNOTATION_DEFAULT),e&&((t=document.createElement(E)).classList.add(J.ANNOTATION_TOOLTIP),t.classList.add(J.ANNOTATION_DEFAULT),t.innerHTML=e,i.appendChild(t)),i}}class mt extends o{constructor(e,{duration:t=300,easing:i=y,scale:s=1,disablePitch:r=!1,disableYaw:n=!1}={}){super(),this._screenScale=new O.Vector2(0,0),this._prevPos=new O.Vector2(0,0),this._isFirstTouch=!1,this._scrolling=!1,this._enabled=!1,this._onMouseDown=e=>{var t;e.button===ne.LEFT&&(t=this._view3D.renderer.canvas,e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.HOLD,{inputType:g.ROTATE}))},this._onMouseMove=e=>{e.preventDefault();var t=this._prevPos,i=new O.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);i.multiply(this._screenScale),this._xMotion.setEndDelta(i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.RELEASE,{inputType:g.ROTATE})},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY),this.trigger(T.HOLD,{inputType:g.ROTATE})},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],i=this._view3D.scrollable;if(this._isFirstTouch){if(i){i=new O.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(i.y)>Math.abs(i.x))return void(this._scrolling=!0)}this._isFirstTouch=!1}!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();i=this._prevPos,e=new O.Vector2(t.clientX,t.clientY).sub(i).multiplyScalar(this._scale);e.multiply(this._screenScale),this._xMotion.setEndDelta(e.x),this._yMotion.setEndDelta(e.y),i.set(t.clientX,t.clientY)}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):(this._prevPos.set(0,0),this.trigger(T.RELEASE,{inputType:g.ROTATE})),this._scrolling=!1},this._view3D=e,this._scale=s,this._duration=t,this._easing=i,this._disablePitch=r,this._disableYaw=n,this._xMotion=new S({duration:t,range:Ie,easing:i}),this._yMotion=new S({duration:t,range:De,easing:i})}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._isFirstTouch=!1,this._scrolling=!1}update(e){var t=this._view3D.camera,i=this._xMotion,s=this._yMotion,t=t.newPose,r=!this._disableYaw,n=!this._disablePitch,i=new O.Vector2(i.update(e),s.update(e));r&&(t.yaw+=i.x),n&&(t.pitch+=i.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.MOUSE_DOWN,this._onMouseDown),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.ROTATE}))}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(m.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.ROTATE}))}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class vt extends o{constructor(e,{easing:t=y,duration:i=0,scale:s=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new O.Vector2(0,0),this._screenSize=new O.Vector2(0,0),this._onMouseDown=e=>{var t;e.button===ne.RIGHT&&(t=this._view3D.renderer.canvas,e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(m.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(T.HOLD,{inputType:g.TRANSLATE}))},this._onMouseMove=e=>{e.preventDefault();var t=this._prevPos,i=new O.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.RELEASE,{inputType:g.TRANSLATE})},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0,this.trigger(T.HOLD,{inputType:g.TRANSLATE}))},this._onTouchMove=e=>{var t,i;2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),e.stopPropagation(),t=this._prevPos,e=this._getTouchesMiddle(e.touches),this._touchInitialized?(i=(new O.Vector2).subVectors(e,t).multiplyScalar(this._scale),this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.copy(e)):(t.copy(e),this._touchInitialized=!0))},this._onTouchEnd=e=>{2!==e.touches.length?this._touchInitialized&&(this._touchInitialized=!1,this.trigger(T.RELEASE,{inputType:g.TRANSLATE})):(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(m.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new S({duration:i,range:Ie,easing:t}),this._yMotion=new S({duration:i,range:Ie,easing:t}),this._scale=s}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._touchInitialized=!1}update(e){var t=this._view3D.camera,i=t.newPose,s=this._screenSize,e=new O.Vector2(this._xMotion.update(e),this._yMotion.update(e)),r=new O.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),n=new O.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion),t=new O.Vector2(t.renderWidth,t.renderHeight).divide(s),s=(e.multiply(t),i.pivot.clone());i.pivot=s.add(r.multiplyScalar(e.x)).add(n.multiplyScalar(e.y))}resize(e){this._screenSize.copy(new O.Vector2(e.width,e.height))}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.TRANSLATE}))}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(m.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(m.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.TRANSLATE}))}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new O.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class gt extends o{constructor(e,{type:t=_e.FOV,scale:i=1,duration:s=300,minFov:r=1,maxFov:n=$,minDistance:a=.1,maxDistance:o=2,doubleTap:l=!0,easing:h=y}={}){super(),this._scaleModifier=1,this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._isFirstTouch=!0,this._isWheelScrolling=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;0===e.deltaY||t||(e.preventDefault(),e.stopPropagation(),t=this._motion,e=-this._scale*this._scaleModifier*this._wheelModifier*e.deltaY,this._isWheelScrolling||this.trigger(T.HOLD,{inputType:g.ZOOM}),this._isWheelScrolling=!0,t.setEndDelta(e))},this._onTouchMove=e=>{var t,i,s=e.touches;2===s.length&&(!1!==e.cancelable&&e.preventDefault(),e.stopPropagation(),e=this._motion,t=this._prevTouchDistance,i=new O.Vector2(s[0].pageX,s[0].pageY),s=new O.Vector2(s[1].pageX,s[1].pageY),i=i.sub(s).length()*this._scale*this._scaleModifier*this._touchModifier,s=this._isFirstTouch?0:i-t,this._prevTouchDistance=i,this._isFirstTouch&&this.trigger(T.HOLD,{inputType:g.ZOOM}),this._isFirstTouch=!1,e.setEndDelta(s))},this._onTouchEnd=e=>{0===e.touches.length&&(this.trigger(T.RELEASE,{inputType:g.ZOOM}),this._prevTouchDistance=-1,this._isFirstTouch=!0)},this._onDoubleClick=e=>{var t=this._view3D;if(this._doubleTap&&t.model){var{zoomIn:i=.8,duration:s=300,easing:r=y,useZoomOut:n=!0}=Z(this._doubleTap),i=-this._motion.range.min*i;if(t.camera.zoom>=i&&n){const l=t.camera.currentPose.clone();l.zoom=0,void t.camera.reset(s,r,l)}else{var n=new O.Raycaster,a=new O.Vector2,o=t.renderer.canvasSize,e=(a.x=e.offsetX/o.x*2-1,a.y=2*-(e.offsetY/o.y)+1,n.setFromCamera(a,t.camera.threeCamera),n.intersectObject(t.model.scene));if(e.length){var o=e[0].point,{yaw:a,pitch:n}=t.camera;const l=new A(a,n,i,o.toArray());t.camera.reset(s,r,l)}}}},this._view3D=e,this._type=t,this._scale=i,this._duration=s,this._minFov=r,this._maxFov=n,this._minDistance=a,this._maxDistance=o,this._doubleTap=l,this._easing=h,this._motion=new S({duration:s,easing:h,range:{min:-1/0,max:1/0}})}get enabled(){return this._enabled}get animating(){return this._motion.activated}get range(){return this._motion.range}get type(){return this._type}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}get doubleTap(){return this._doubleTap}get easing(){return this._easing}set type(e){this._type=e}set scale(e){this._scale=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._prevTouchDistance=-1,this._isFirstTouch=!0,this._isWheelScrolling=!1}update(e){var t=this._view3D.camera.newPose,i=this._motion,s=i.progress,e=i.update(e),i=i.progress;t.zoom-=e,this._isWheelScrolling&&s<1&&1<=i&&(this.trigger(T.RELEASE,{inputType:g.ZOOM}),this._isWheelScrolling=!1)}resize(e){}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(m.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.ZOOM}))}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.WHEEL,this._onWheel,!1),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(m.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(m.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.ZOOM}))}sync(){var e=this._view3D.camera;this._motion.reset(-e.zoom),this._type===_e.FOV?this._scaleModifier=-1:this._scaleModifier=-e.baseDistance/44}updateRange(){var e,t,i=this._motion.range,s=this._view3D["camera"];this._type===_e.FOV?(e=s.baseFov,t=this._maxFov,i.max=t===$?Math.min(e+45,175)-e:t-e,i.min=this._minFov-e):(i.max=s.baseDistance*this._maxDistance-s.baseDistance,i.min=s.baseDistance*this._minDistance-s.baseDistance)}}class Et{constructor(e){this._onEnable=({inputType:e})=>{var t;e!==g.ZOOM&&(t=(e=this._view3D).renderer.canvas,e.useGrabCursor)&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===i.NONE&&this._setCursor(i.GRAB)},this._onDisable=({inputType:e})=>{e===g.ZOOM||this._view3D.renderer.canvas.style.cursor===i.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(i.NONE)},this._onHold=({inputType:e})=>{var t=this._view3D;e!==g.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(i.GRABBING),t.trigger(f.INPUT_START,{type:f.INPUT_START,target:t,inputType:e})},this._onRelease=({inputType:e})=>{var t=this._view3D;e!==g.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(i.GRAB),t.trigger(f.INPUT_END,{type:f.INPUT_END,target:t,inputType:e})},this._view3D=e,this._rotateControl=new mt(e,Z(e.rotate)),this._translateControl=new vt(e,Z(e.translate)),this._zoomControl=new gt(e,Z(e.zoom)),this._extraControls=[],[this._rotateControl,this._translateControl,this._zoomControl].forEach(e=>{e.on({[T.HOLD]:this._onHold,[T.RELEASE]:this._onRelease,[T.ENABLE]:this._onEnable,[T.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}get controls(){return[this._rotateControl,this._translateControl,this._zoomControl]}get extraControls(){return this._extraControls}get animating(){return this._rotateControl.animating||this._translateControl.animating||this._zoomControl.animating||this._extraControls.some(e=>e.animating)}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy(),this._extraControls.forEach(e=>e.destroy()),this._extraControls=[]}update(t){this._rotateControl.update(t),this._translateControl.update(t),this._zoomControl.update(t),this._extraControls.forEach(e=>e.update(t))}resize(t){this._rotateControl.resize(t),this._translateControl.resize(t),this._zoomControl.resize(t),this._extraControls.forEach(e=>e.resize(t))}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable(),this._extraControls.forEach(e=>e.enable())}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable(),this._extraControls.forEach(e=>e.disable())}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync(),this._extraControls.forEach(e=>e.sync())}add(e){this._extraControls.push(e)}remove(t){var e=this._extraControls,i=e.findIndex(e=>e===t);0<=i&&e.splice(i,1)}updateCursor(){var e=this._view3D.useGrabCursor?i.GRAB:i.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;!t.useGrabCursor&&e!==i.NONE||(t.renderer.canvas.style.cursor=e)}}class ft{constructor(e,{delay:t=2e3,delayOnMouseLeave:i=0,speed:s=1,pauseOnHover:r=!1,canInterrupt:n=!0,disableOnInterrupt:a=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{!this._canInterrupt||e.button!==ne.LEFT&&e.button!==ne.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1))},this._onMouseUp=()=>{window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=i,this._speed=s,this._pauseOnHover=r,this._canInterrupt=n,this._disableOnInterrupt=a}get enabled(){return this._enabled}get animating(){return this._enabled&&!this._interrupted}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){this._enabled&&(this._interrupted?this._disableOnInterrupt&&this.disable():this._view3D.camera.newPose.yaw+=this._speed*e/100)}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(m.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(m.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(m.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0)}enableAfterDelay(){this.enable(),this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay)}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(m.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(m.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(m.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(m.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout())}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Tt extends O.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new St(e)}),this.register(function(e){return new Ct(e)}),this.register(function(e){return new Mt(e)}),this.register(function(e){return new At(e)}),this.register(function(e){return new Lt(e)}),this.register(function(e){return new Rt(e)}),this.register(function(e){return new xt(e)}),this.register(function(e){return new Ot(e)}),this.register(function(e){return new bt(e)}),this.register(function(e){return new It(e)})}load(t,i,e,s){const r=this;let n;n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:O.LoaderUtils.extractUrlBase(t),this.manager.itemStart(t);function a(e){s?s(e):console.error(e),r.manager.itemError(t),r.manager.itemEnd(t)}var o=new O.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,function(e){try{r.parse(e,n,function(e){i(e),r.manager.itemEnd(t)},a)}catch(e){a(e)}},e,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let r;var n={},a={};if("string"==typeof e)r=e;else if(O.LoaderUtils.decodeText(new Uint8Array(e,0,4))===Dt){try{n[R.KHR_BINARY_GLTF]=new Nt(e)}catch(e){return void(s&&s(e))}r=n[R.KHR_BINARY_GLTF].content}else r=O.LoaderUtils.decodeText(new Uint8Array(e));var o=JSON.parse(r);if(void 0===o.asset||o.asset.version[0]<2)s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var l=new ti(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){var h=this.pluginCallbacks[e](l);n[(a[h.name]=h).name]=!0}if(o.extensionsUsed)for(let e=0;e<o.extensionsUsed.length;++e){var c=o.extensionsUsed[e],d=o.extensionsRequired||[];switch(c){case R.KHR_MATERIALS_UNLIT:n[c]=new yt;break;case R.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:n[c]=new kt;break;case R.KHR_DRACO_MESH_COMPRESSION:n[c]=new Ft(o,this.dracoLoader);break;case R.KHR_TEXTURE_TRANSFORM:n[c]=new Ut;break;case R.KHR_MESH_QUANTIZATION:n[c]=new Ht;break;default:0<=d.indexOf(c)&&void 0===a[c]&&console.warn('THREE.GLTFLoader: Unknown extension "'+c+'".')}}l.setExtensions(n),l.setPlugins(a),l.parse(i,s)}}}function wt(){let i={};return{get:function(e){return i[e]},add:function(e,t){i[e]=t},remove:function(e){delete i[e]},removeAll:function(){i={}}}}const R={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class bt{constructor(e){this.parser=e,this.name=R.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){var i=this.parser,s=this.parser.json.nodes||[];for(let e=0,t=s.length;e<t;e++){var r=s[e];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&i._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(t){var i=this.parser,s="light:"+t,r=i.cache.get(s);if(!r){var n=i.json,a=((n.extensions&&n.extensions[this.name]||{}).lights||[])[t];let e;var o=new O.Color(16777215),l=(void 0!==a.color&&o.fromArray(a.color),void 0!==a.range?a.range:0);switch(a.type){case"directional":(e=new O.DirectionalLight(o)).target.position.set(0,0,-1),e.add(e.target);break;case"point":(e=new O.PointLight(o)).distance=l;break;case"spot":(e=new O.SpotLight(o)).distance=l,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,e.angle=a.spot.outerConeAngle,e.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,e.target.position.set(0,0,-1),e.add(e.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}e.position.set(0,0,0),e.decay=2,void 0!==a.intensity&&(e.intensity=a.intensity),e.name=i.createUniqueName(a.name||"light_"+t),r=Promise.resolve(e),i.cache.add(s,r)}return r}createNodeAttachment(e){const t=this,i=this.parser;e=i.json.nodes[e];const s=(e.extensions&&e.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then(function(e){return i._getNodeRef(t.cache,s,e)})}}class yt{constructor(){this.name=R.KHR_MATERIALS_UNLIT}getMaterialType(){return O.MeshBasicMaterial}extendParams(e,t,i){var s,r=[],t=(e.color=new O.Color(1,1,1),e.opacity=1,t.pbrMetallicRoughness);return t&&(Array.isArray(t.baseColorFactor)&&(s=t.baseColorFactor,e.color.fromArray(s),e.opacity=s[3]),void 0!==t.baseColorTexture)&&r.push(i.assignTexture(e,"map",t.baseColorTexture)),Promise.all(r)}}class St{constructor(e){this.parser=e,this.name=R.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],void 0!==(e=e.extensions[this.name]).clearcoatFactor&&(t.clearcoat=e.clearcoatFactor),void 0!==e.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",e.clearcoatTexture)),void 0!==e.clearcoatRoughnessFactor&&(t.clearcoatRoughness=e.clearcoatRoughnessFactor),void 0!==e.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",e.clearcoatRoughnessTexture)),void 0!==e.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",e.clearcoatNormalTexture)),void 0!==e.clearcoatNormalTexture.scale)&&(s=e.clearcoatNormalTexture.scale,t.clearcoatNormalScale=new O.Vector2(s,s)),Promise.all(i)):Promise.resolve()}}class At{constructor(e){this.parser=e,this.name=R.KHR_MATERIALS_SHEEN}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],t.sheenColor=new O.Color(0,0,0),t.sheenRoughness=0,t.sheen=1,void 0!==(e=e.extensions[this.name]).sheenColorFactor&&t.sheenColor.fromArray(e.sheenColorFactor),void 0!==e.sheenRoughnessFactor&&(t.sheenRoughness=e.sheenRoughnessFactor),void 0!==e.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",e.sheenColorTexture)),void 0!==e.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",e.sheenRoughnessTexture)),Promise.all(i)):Promise.resolve()}}class Lt{constructor(e){this.parser=e,this.name=R.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],void 0!==(e=e.extensions[this.name]).transmissionFactor&&(t.transmission=e.transmissionFactor),void 0!==e.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",e.transmissionTexture)),Promise.all(i)):Promise.resolve()}}class Rt{constructor(e){this.parser=e,this.name=R.KHR_MATERIALS_VOLUME}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],e=e.extensions[this.name],t.thickness=void 0!==e.thicknessFactor?e.thicknessFactor:0,void 0!==e.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",e.thicknessTexture)),t.attenuationDistance=e.attenuationDistance||0,s=e.attenuationColor||[1,1,1],t.attenuationColor=new O.Color(s[0],s[1],s[2]),Promise.all(i)):Promise.resolve()}}class xt{constructor(e){this.parser=e,this.name=R.KHR_MATERIALS_IOR}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]&&(e=e.extensions[this.name],t.ior=void 0!==e.ior?e.ior:1.5),Promise.resolve()}}class Ot{constructor(e){this.parser=e,this.name=R.KHR_MATERIALS_SPECULAR}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?O.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s,r=this.parser,e=r.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],e=e.extensions[this.name],t.specularIntensity=void 0!==e.specularFactor?e.specularFactor:1,void 0!==e.specularTexture&&i.push(r.assignTexture(t,"specularIntensityMap",e.specularTexture)),s=e.specularColorFactor||[1,1,1],t.specularColor=new O.Color(s[0],s[1],s[2]),void 0!==e.specularColorTexture&&i.push(r.assignTexture(t,"specularColorMap",e.specularColorTexture).then(function(e){e.encoding=O.sRGBEncoding})),Promise.all(i)):Promise.resolve()}}class Ct{constructor(e){this.parser=e,this.name=R.KHR_TEXTURE_BASISU}loadTexture(e){var t=this.parser,i=t.json,s=i.textures[e];if(s.extensions&&s.extensions[this.name]){var s=s.extensions[this.name],s=i.images[s.source],r=t.options.ktx2Loader;if(r)return t.loadTextureImage(e,s,r);if(i.extensionsRequired&&0<=i.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return null}}class Mt{constructor(e){this.parser=e,this.name=R.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const i=this.name,s=this.parser,r=s.json;var e=r.textures[t];if(!e.extensions||!e.extensions[i])return null;var e=e.extensions[i];const n=r.images[e.source];let a=s.textureLoader;return n.uri&&null!==(e=s.options.manager.getHandler(n.uri))&&(a=e),this.detectSupport().then(function(e){if(e)return s.loadTextureImage(t,n,a);if(r.extensionsRequired&&0<=r.extensionsRequired.indexOf(i))throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class It{constructor(e){this.name=R.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){var t=this.parser.json,e=t.bufferViews[e];if(e.extensions&&e.extensions[this.name]){const a=e.extensions[this.name];e=this.parser.getDependency("buffer",a.buffer);const o=this.parser.options.meshoptDecoder;if(o&&o.supported)return Promise.all([e,o.ready]).then(function(e){var t=a.byteOffset||0,i=a.byteLength||0,s=a.count,r=a.byteStride,n=new ArrayBuffer(s*r),e=new Uint8Array(e[0],t,i);return o.decodeGltfBuffer(new Uint8Array(n),s,r,e,a.mode,a.filter),n});if(t.extensionsRequired&&0<=t.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return null}}const Dt="glTF",Pt={JSON:1313821514,BIN:5130562};class Nt{constructor(e){this.name=R.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:O.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Dt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");var i=this.header.length-12,s=new DataView(e,12);let r=0;for(;r<i;){var n,a=s.getUint32(r,!0),o=(r+=4,s.getUint32(r,!0));r+=4,o===Pt.JSON?(n=new Uint8Array(e,12+r,a),this.content=O.LoaderUtils.decodeText(n)):o===Pt.BIN&&(n=12+r,this.body=e.slice(n,n+a)),r+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ft{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=R.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){var i=this.json;const s=this.dracoLoader;var r=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes;const a={},o={},l={};for(const _ in n){var h=qt[_]||_.toLowerCase();a[h]=n[_]}for(const p in e.attributes){var c,d,u=qt[p]||p.toLowerCase();void 0!==n[p]&&(c=i.accessors[e.attributes[p]],d=Wt[c.componentType],l[u]=d,o[u]=!0===c.normalized)}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(r){s.decodeDracoFile(e,function(e){for(const s in e.attributes){var t=e.attributes[s],i=o[s];void 0!==i&&(t.normalized=i)}r(e)},a,l)})})}}class Ut{constructor(){this.name=R.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Bt extends O.MeshStandardMaterial{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const i=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),r=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new O.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(const t in o)e.uniforms[t]=o[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",i).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",r).replace("#include <metalnessmap_fragment>",n).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){(o.specularMap.value=e)?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){(o.glossinessMap.value=e)?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class kt{constructor(){this.name=R.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Bt}extendParams(e,t,i){var s,t=t.extensions[this.name],r=(e.color=new O.Color(1,1,1),e.opacity=1,[]);return Array.isArray(t.diffuseFactor)&&(s=t.diffuseFactor,e.color.fromArray(s),e.opacity=s[3]),void 0!==t.diffuseTexture&&r.push(i.assignTexture(e,"map",t.diffuseTexture)),e.emissive=new O.Color(0,0,0),e.glossiness=void 0!==t.glossinessFactor?t.glossinessFactor:1,e.specular=new O.Color(1,1,1),Array.isArray(t.specularFactor)&&e.specular.fromArray(t.specularFactor),void 0!==t.specularGlossinessTexture&&(s=t.specularGlossinessTexture,r.push(i.assignTexture(e,"glossinessMap",s)),r.push(i.assignTexture(e,"specularMap",s))),Promise.all(r)}createMaterial(e){var t=new Bt(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=O.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class Ht{constructor(){this.name=R.KHR_MESH_QUANTIZATION}}class Gt extends O.Interpolant{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){var t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,r=e*s*3+s;for(let e=0;e!==s;e++)t[e]=i[r+e];return t}}Gt.prototype.beforeStart_=Gt.prototype.copySampleValue_,Gt.prototype.afterEnd_=Gt.prototype.copySampleValue_,Gt.prototype.interpolate_=function(e,t,i,s){var r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,h=s-t,s=(i-t)/h,i=s*s,t=i*s,c=e*l,d=c-l,u=-2*t+3*i,_=t-i,p=1-u,m=_-i+s;for(let e=0;e!==a;e++){var v=n[d+e+a],g=n[d+e+o]*h,E=n[c+e+a],f=n[c+e]*h;r[e]=p*v+m*g+u*E+_*f}return r};const Vt=new O.Quaternion;class zt extends Gt{interpolate_(e,t,i,s){e=super.interpolate_(e,t,i,s);return Vt.fromArray(e).normalize().toArray(e),e}}const x={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Wt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},jt={9728:O.NearestFilter,9729:O.LinearFilter,9984:O.NearestMipmapNearestFilter,9985:O.LinearMipmapNearestFilter,9986:O.NearestMipmapLinearFilter,9987:O.LinearMipmapLinearFilter},Kt={33071:O.ClampToEdgeWrapping,33648:O.MirroredRepeatWrapping,10497:O.RepeatWrapping},Xt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},qt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},C={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Yt={CUBICSPLINE:void 0,LINEAR:O.InterpolateLinear,STEP:O.InterpolateDiscrete},Zt={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Qt(e,t,i){for(const s in i.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=i.extensions[s])}function $t(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Jt(i){let s="";var r=Object.keys(i).sort();for(let e=0,t=r.length;e<t;e++)s+=r[e]+":"+i[r[e]]+";";return s}function ei(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class ti{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new wt,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new O.ImageBitmapLoader(this.options.manager):this.textureLoader=new O.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new O.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(i,e){const s=this,r=this.json,n=this.extensions;this.cache.removeAll(),this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(e){const t={scene:e[0][r.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:r.asset,parser:s,userData:{}};Qt(n,t,r),$t(t,r),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(t)})).then(function(){i(t)})}).catch(e)}_markDefs(){var i=this.json.nodes||[],s=this.json.skins||[],r=this.json.meshes||[];for(let e=0,t=s.length;e<t;e++){var n=s[e].joints;for(let e=0,t=n.length;e<t;e++)i[n[e]].isBone=!0}for(let e=0,t=i.length;e<t;e++){var a=i[e];void 0!==a.mesh&&(this._addNodeRef(this.meshCache,a.mesh),void 0!==a.skin)&&(r[a.mesh].isSkinnedMesh=!0),void 0!==a.camera&&this._addNodeRef(this.cameraCache,a.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;var s=i.clone();const n=(e,t)=>{var i,s,r=this.associations.get(e);null!=r&&this.associations.set(t,r);for([i,s]of e.children.entries())n(s,t.children[i])};return n(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(t){var i=Object.values(this.plugins);i.push(this);for(let e=0;e<i.length;e++){var s=t(i[e]);if(s)return s}return null}_invokeAll(t){var i=Object.values(this.plugins),s=(i.unshift(this),[]);for(let e=0;e<i.length;e++){var r=t(i[e]);r&&s.push(r)}return s}getDependency(e,t){var i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this.loadNode(t);break;case"mesh":s=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this.loadAnimation(t);break;case"camera":s=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,s)}return s}getDependencies(i){let e=this.cache.get(i);if(!e){const s=this;var t=this.json[i+("mesh"===i?"es":"s")]||[];e=Promise.all(t.map(function(e,t){return s.getDependency(i,t)})),this.cache.add(i,e)}return e}loadBuffer(e){const i=this.json.buffers[e],s=this.fileLoader;if(i.type&&"arraybuffer"!==i.type)throw new Error("THREE.GLTFLoader: "+i.type+" buffer type is not supported.");if(void 0===i.uri&&0===e)return Promise.resolve(this.extensions[R.KHR_BINARY_GLTF].body);const r=this.options;return new Promise(function(e,t){s.load(O.LoaderUtils.resolveURL(i.uri,r.path),e,void 0,function(){t(new Error('THREE.GLTFLoader: Failed to load buffer "'+i.uri+'".'))})})}loadBufferView(e){const s=this.json.bufferViews[e];return this.getDependency("buffer",s.buffer).then(function(e){var t=s.byteLength||0,i=s.byteOffset||0;return e.slice(i,i+t)})}loadAccessor(e){const m=this,v=this.json,g=this.json.accessors[e];return void 0===g.bufferView&&void 0===g.sparse?Promise.resolve(null):(e=[],void 0!==g.bufferView?e.push(this.getDependency("bufferView",g.bufferView)):e.push(null),void 0!==g.sparse&&(e.push(this.getDependency("bufferView",g.sparse.indices.bufferView)),e.push(this.getDependency("bufferView",g.sparse.values.bufferView))),Promise.all(e).then(function(e){var t=e[0],i=Xt[g.type],s=Wt[g.componentType],r=s.BYTES_PER_ELEMENT,n=r*i,a=g.byteOffset||0,o=void 0!==g.bufferView?v.bufferViews[g.bufferView].byteStride:void 0,l=!0===g.normalized;let h,c;if(o&&o!==n){var n=Math.floor(a/o),d="InterleavedBuffer:"+g.bufferView+":"+g.componentType+":"+n+":"+g.count;let e=m.cache.get(d);e||(h=new s(t,n*o,g.count*o/r),e=new O.InterleavedBuffer(h,o/r),m.cache.add(d,e)),c=new O.InterleavedBufferAttribute(e,i,a%o/r,l)}else h=null===t?new s(g.count*i):new s(t,a,g.count*i),c=new O.BufferAttribute(h,i,l);if(void 0!==g.sparse){var n=Xt.SCALAR,d=Wt[g.sparse.indices.componentType],o=g.sparse.indices.byteOffset||0,r=g.sparse.values.byteOffset||0,u=new d(e[1],o,g.sparse.count*n),_=new s(e[2],r,g.sparse.count*i);null!==t&&(c=new O.BufferAttribute(c.array.slice(),c.itemSize,c.normalized));for(let e=0,t=u.length;e<t;e++){var p=u[e];if(c.setX(p,_[e*i]),2<=i&&c.setY(p,_[e*i+1]),3<=i&&c.setZ(p,_[e*i+2]),4<=i&&c.setW(p,_[e*i+3]),5<=i)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return c}))}loadTexture(e){var t=this.json,i=this.options,s=t.textures[e],t=t.images[s.source];let r=this.textureLoader;return t.uri&&null!==(s=i.manager.getHandler(t.uri))&&(r=s),this.loadTextureImage(e,t,r)}loadTextureImage(i,t,r){const s=this,n=this.json,a=this.options,o=n.textures[i];var e=(t.uri||t.bufferView)+":"+o.sampler;if(this.textureCache[e])return this.textureCache[e];const l=self.URL||self.webkitURL;let h=t.uri||"",c=!1;if(void 0!==t.bufferView)h=s.getDependency("bufferView",t.bufferView).then(function(e){c=!0;e=new Blob([e],{type:t.mimeType});return h=l.createObjectURL(e)});else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+i+" is missing URI and bufferView");var d=Promise.resolve(h).then(function(s){return new Promise(function(t,e){let i=t;!0===r.isImageBitmapLoader&&(i=function(e){e=new O.Texture(e);e.needsUpdate=!0,t(e)}),r.load(O.LoaderUtils.resolveURL(s,a.path),i,void 0,e)})}).then(function(e){!0===c&&l.revokeObjectURL(h),e.flipY=!1,o.name&&(e.name=o.name);var t=(n.samplers||{})[o.sampler]||{};return e.magFilter=jt[t.magFilter]||O.LinearFilter,e.minFilter=jt[t.minFilter]||O.LinearMipmapLinearFilter,e.wrapS=Kt[t.wrapS]||O.RepeatWrapping,e.wrapT=Kt[t.wrapT]||O.RepeatWrapping,s.associations.set(e,{textures:i}),e}).catch(function(){return console.error("THREE.GLTFLoader: Couldn't load texture",h),null});return this.textureCache[e]=d}assignTexture(s,r,n){const a=this;return this.getDependency("texture",n.index).then(function(e){var t,i;return void 0===n.texCoord||0==n.texCoord||"aoMap"===r&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+r+" not yet supported."),a.extensions[R.KHR_TEXTURE_TRANSFORM]&&(t=void 0!==n.extensions?n.extensions[R.KHR_TEXTURE_TRANSFORM]:void 0)&&(i=a.associations.get(e),e=a.extensions[R.KHR_TEXTURE_TRANSFORM].extendTexture(e,t),a.associations.set(e,i)),s[r]=e})}assignFinalMaterial(e){var t=e.geometry;let i=e.material;var s=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){var a="PointsMaterial:"+i.uuid;let e=this.cache.get(a);e||(e=new O.PointsMaterial,O.Material.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,e.sizeAttenuation=!1,this.cache.add(a,e)),i=e}else if(e.isLine){a="LineBasicMaterial:"+i.uuid;let e=this.cache.get(a);e||(e=new O.LineBasicMaterial,O.Material.prototype.copy.call(e,i),e.color.copy(i.color),this.cache.add(a,e)),i=e}if(s||r||n){let e="ClonedMaterial:"+i.uuid+":",t=(i.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),s&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),n&&(e+="flat-shading:"),this.cache.get(e));t||(t=i.clone(),r&&(t.vertexColors=!0),n&&(t.flatShading=!0),s&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale)&&(t.clearcoatNormalScale.y*=-1),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i}getMaterialType(){return O.MeshStandardMaterial}loadMaterial(t){const i=this;var e=this.json;const s=this.extensions,r=e.materials[t];let n;const a={};var e=r.extensions||{},o=[],l=(e[R.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]?(l=s[R.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS],n=l.getMaterialType(),o.push(l.extendParams(a,r,i))):e[R.KHR_MATERIALS_UNLIT]?(l=s[R.KHR_MATERIALS_UNLIT],n=l.getMaterialType(),o.push(l.extendParams(a,r,i))):(e=r.pbrMetallicRoughness||{},a.color=new O.Color(1,1,1),a.opacity=1,Array.isArray(e.baseColorFactor)&&(l=e.baseColorFactor,a.color.fromArray(l),a.opacity=l[3]),void 0!==e.baseColorTexture&&o.push(i.assignTexture(a,"map",e.baseColorTexture)),a.metalness=void 0!==e.metallicFactor?e.metallicFactor:1,a.roughness=void 0!==e.roughnessFactor?e.roughnessFactor:1,void 0!==e.metallicRoughnessTexture&&(o.push(i.assignTexture(a,"metalnessMap",e.metallicRoughnessTexture)),o.push(i.assignTexture(a,"roughnessMap",e.metallicRoughnessTexture))),n=this._invokeOne(function(e){return e.getMaterialType&&e.getMaterialType(t)}),o.push(Promise.all(this._invokeAll(function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,a)})))),!0===r.doubleSided&&(a.side=O.DoubleSide),r.alphaMode||Zt.OPAQUE);return l===Zt.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.format=O.RGBFormat,a.transparent=!1,l===Zt.MASK&&(a.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&n!==O.MeshBasicMaterial&&(o.push(i.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new O.Vector2(1,1),void 0!==r.normalTexture.scale)&&(e=r.normalTexture.scale,a.normalScale.set(e,e)),void 0!==r.occlusionTexture&&n!==O.MeshBasicMaterial&&(o.push(i.assignTexture(a,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength)&&(a.aoMapIntensity=r.occlusionTexture.strength),void 0!==r.emissiveFactor&&n!==O.MeshBasicMaterial&&(a.emissive=(new O.Color).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&n!==O.MeshBasicMaterial&&o.push(i.assignTexture(a,"emissiveMap",r.emissiveTexture)),Promise.all(o).then(function(){let e;return e=n===Bt?s[R.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new n(a),r.name&&(e.name=r.name),e.map&&(e.map.encoding=O.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=O.sRGBEncoding),$t(e,r),i.associations.set(e,{materials:t}),r.extensions&&Qt(s,e,r),e})}createUniqueName(e){var t=O.PropertyBinding.sanitizeNodeName(e||"");let i=t;for(let e=1;this.nodeNamesUsed[i];++e)i=t+"_"+e;return this.nodeNamesUsed[i]=!0,i}loadGeometries(i){const s=this,r=this.extensions;var n=this.primitiveCache;var a=[];for(let e=0,t=i.length;e<t;e++){var o=i[e],l=function(e){var t=e.extensions&&e.extensions[R.KHR_DRACO_MESH_COMPRESSION];let i;return i=t?"draco:"+t.bufferView+":"+t.indices+":"+Jt(t.attributes):e.indices+":"+Jt(e.attributes)+":"+e.mode}(o),h=n[l];if(h)a.push(h.promise);else{let e;e=o.extensions&&o.extensions[R.KHR_DRACO_MESH_COMPRESSION]?function(t){return r[R.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,s).then(function(e){return ii(e,t,s)})}(o):ii(new O.BufferGeometry,o,s),n[l]={primitive:o,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(u){const _=this;var e=this.json;const p=this.extensions,m=e.meshes[u],v=m.primitives;var i=[];for(let e=0,t=v.length;e<t;e++){var s=void 0===v[e].material?(void 0===(s=this.cache).DefaultMaterial&&(s.DefaultMaterial=new O.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:O.FrontSide})),s.DefaultMaterial):this.getDependency("material",v[e].material);i.push(s)}return i.push(_.loadGeometries(v)),Promise.all(i).then(function(e){var i=e.slice(0,e.length-1),s=e[e.length-1],r=[];for(let t=0,e=s.length;t<e;t++){var n=s[t],a=v[t];let e;var o=i[t];if(a.mode===x.TRIANGLES||a.mode===x.TRIANGLE_STRIP||a.mode===x.TRIANGLE_FAN||void 0===a.mode)!0!==(e=new(!0===m.isSkinnedMesh?O.SkinnedMesh:O.Mesh)(n,o)).isSkinnedMesh||e.geometry.attributes.skinWeight.normalized||e.normalizeSkinWeights(),a.mode===x.TRIANGLE_STRIP?e.geometry=si(e.geometry,O.TriangleStripDrawMode):a.mode===x.TRIANGLE_FAN&&(e.geometry=si(e.geometry,O.TriangleFanDrawMode));else if(a.mode===x.LINES)e=new O.LineSegments(n,o);else if(a.mode===x.LINE_STRIP)e=new O.Line(n,o);else if(a.mode===x.LINE_LOOP)e=new O.LineLoop(n,o);else{if(a.mode!==x.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+a.mode);e=new O.Points(n,o)}if(0<Object.keys(e.geometry.morphAttributes).length){c=h=l=void 0;var l=e,h=m;if(l.updateMorphTargets(),void 0!==h.weights)for(let e=0,t=h.weights.length;e<t;e++)l.morphTargetInfluences[e]=h.weights[e];if(h.extras&&Array.isArray(h.extras.targetNames)){var c=h.extras.targetNames;if(l.morphTargetInfluences.length===c.length){l.morphTargetDictionary={};for(let e=0,t=c.length;e<t;e++)l.morphTargetDictionary[c[e]]=e}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}e.name=_.createUniqueName(m.name||"mesh_"+u),$t(e,m),a.extensions&&Qt(p,e,a),_.assignFinalMaterial(e),r.push(e)}for(let e=0,t=r.length;e<t;e++)_.associations.set(r[e],{meshes:u,primitives:e});if(1===r.length)return r[0];var d=new O.Group;_.associations.set(d,{meshes:u});for(let e=0,t=r.length;e<t;e++)d.add(r[e]);return d})}loadCamera(e){let t;var e=this.json.cameras[e],i=e[e.type];if(i)return"perspective"===e.type?t=new O.PerspectiveCamera(O.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===e.type&&(t=new O.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),e.name&&(t.name=this.createUniqueName(e.name)),$t(t,e),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){e=this.json.skins[e];const t={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(t):this.getDependency("accessor",e.inverseBindMatrices).then(function(e){return t.inverseBindMatrices=e,t})}loadAnimation(t){const f=this.json.animations[t];var i=[],s=[],r=[],n=[],a=[];for(let e=0,t=f.channels.length;e<t;e++){var o=f.channels[e],l=f.samplers[o.sampler],o=o.target,h=void 0!==o.node?o.node:o.id,c=void 0!==f.parameters?f.parameters[l.input]:l.input,d=void 0!==f.parameters?f.parameters[l.output]:l.output;i.push(this.getDependency("node",h)),s.push(this.getDependency("accessor",c)),r.push(this.getDependency("accessor",d)),n.push(l),a.push(o)}return Promise.all([Promise.all(i),Promise.all(s),Promise.all(r),Promise.all(n),Promise.all(a)]).then(function(e){var i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],o=[];for(let e=0,t=i.length;e<t;e++){var l=i[e],h=s[e],c=r[e],d=n[e],u=a[e];if(void 0!==l){l.updateMatrix(),l.matrixAutoUpdate=!0;let i;switch(C[u.path]){case C.weights:i=O.NumberKeyframeTrack;break;case C.rotation:i=O.QuaternionKeyframeTrack;break;case C.position:case C.scale:default:i=O.VectorKeyframeTrack}var _=l.name||l.uuid,p=void 0!==d.interpolation?Yt[d.interpolation]:O.InterpolateLinear;const E=[];C[u.path]===C.weights?l.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&E.push(e.name||e.uuid)}):E.push(_);let s=c.array;if(c.normalized){var m=ei(s.constructor),v=new Float32Array(s.length);for(let e=0,t=s.length;e<t;e++)v[e]=s[e]*m;s=v}for(let e=0,t=E.length;e<t;e++){var g=new i(E[e]+"."+C[u.path],h.array,s,p);"CUBICSPLINE"===d.interpolation&&(g.createInterpolant=function(e){return new(this instanceof O.QuaternionKeyframeTrack?zt:Gt)(this.times,this.values,this.getValueSize()/3,e)},g.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),o.push(g)}}}e=f.name||"animation_"+t;return new O.AnimationClip(e,void 0,o)})}createNodeMesh(e){var t=this.json;const i=this,s=t.nodes[e];return void 0===s.mesh?null:i.getDependency("mesh",s.mesh).then(function(e){e=i._getNodeRef(i.meshCache,s.mesh,e);return void 0!==s.weights&&e.traverse(function(i){if(i.isMesh)for(let e=0,t=s.weights.length;e<t;e++)i.morphTargetInfluences[e]=s.weights[e]}),e})}loadNode(r){var e=this.json;const t=this.extensions,n=this,a=e.nodes[r],o=a.name?n.createUniqueName(a.name):"";return function(){const t=[];var e=n._invokeOne(function(e){return e.createNodeMesh&&e.createNodeMesh(r)});return e&&t.push(e),void 0!==a.camera&&t.push(n.getDependency("camera",a.camera).then(function(e){return n._getNodeRef(n.cameraCache,a.camera,e)})),n._invokeAll(function(e){return e.createNodeAttachment&&e.createNodeAttachment(r)}).forEach(function(e){t.push(e)}),Promise.all(t)}().then(function(i){let s;if((s=!0===a.isBone?new O.Bone:1<i.length?new O.Group:1===i.length?i[0]:new O.Object3D)!==i[0])for(let e=0,t=i.length;e<t;e++)s.add(i[e]);var e;return a.name&&(s.userData.name=a.name,s.name=o),$t(s,a),a.extensions&&Qt(t,s,a),void 0!==a.matrix?((e=new O.Matrix4).fromArray(a.matrix),s.applyMatrix4(e)):(void 0!==a.translation&&s.position.fromArray(a.translation),void 0!==a.rotation&&s.quaternion.fromArray(a.rotation),void 0!==a.scale&&s.scale.fromArray(a.scale)),n.associations.has(s)||n.associations.set(s,{}),n.associations.get(s).nodes=r,s})}loadScene(e){var i=this.json,t=this.extensions,e=this.json.scenes[e];const r=this,s=new O.Group;e.name&&(s.name=r.createUniqueName(e.name)),$t(s,e),e.extensions&&Qt(t,s,e);var n=e.nodes||[],a=[];for(let e=0,t=n.length;e<t;e++)a.push(function a(e,t,o,l){const h=o.nodes[e];return l.getDependency("node",e).then(function(e){if(void 0===h.skin)return e;let o;return l.getDependency("skin",h.skin).then(function(e){o=e;const i=[];for(let e=0,t=o.joints.length;e<t;e++)i.push(l.getDependency("node",o.joints[e]));return Promise.all(i)}).then(function(a){return e.traverse(function(e){if(e.isMesh){const i=[],s=[];for(let e=0,t=a.length;e<t;e++){const r=a[e];if(r){i.push(r);const n=new O.Matrix4;void 0!==o.inverseBindMatrices&&n.fromArray(o.inverseBindMatrices.array,16*e),s.push(n)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',o.joints[e])}e.bind(new O.Skeleton(i,s),e.matrixWorld)}}),e})}).then(function(i){t.add(i);const s=[];if(h.children){const r=h.children;for(let e=0,t=r.length;e<t;e++){const n=r[e];s.push(a(n,i,o,l))}}return Promise.all(s)})}(n[e],s,i,r));return Promise.all(a).then(function(){return r.associations=(e=>{const i=new Map;for(var[t,s]of r.associations)(t instanceof O.Material||t instanceof O.Texture)&&i.set(t,s);return e.traverse(e=>{var t=r.associations.get(e);null!=t&&i.set(e,t)}),i})(s),s})}}function ii(u,e,_){var t=e.attributes,i=[];for(const f in t){var s=qt[f]||f.toLowerCase();s in u.attributes||i.push(function(e,t){return _.getDependency("accessor",e).then(function(e){u.setAttribute(t,e)})}(t[f],s))}void 0===e.indices||u.index||(r=_.getDependency("accessor",e.indices).then(function(e){u.setIndex(e)}),i.push(r)),$t(u,e);var r=u,n=e,a=_,o=n.attributes,l=new O.Box3;if(void 0!==o.POSITION){var o=a.json.accessors[o.POSITION],h=o.min,c=o.max;if(void 0===h||void 0===c)console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");else{l.set(new O.Vector3(h[0],h[1],h[2]),new O.Vector3(c[0],c[1],c[2])),o.normalized&&(h=ei(Wt[o.componentType]),l.min.multiplyScalar(h),l.max.multiplyScalar(h));var d=n.targets;if(void 0!==d){var p=new O.Vector3,m=new O.Vector3;for(let e=0,t=d.length;e<t;e++){var v,g,E=d[e];void 0!==E.POSITION&&(g=(E=a.json.accessors[E.POSITION]).min,v=E.max,void 0!==g&&void 0!==v?(m.setX(Math.max(Math.abs(g[0]),Math.abs(v[0]))),m.setY(Math.max(Math.abs(g[1]),Math.abs(v[1]))),m.setZ(Math.max(Math.abs(g[2]),Math.abs(v[2]))),E.normalized&&(g=ei(Wt[E.componentType]),m.multiplyScalar(g)),p.max(m)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION."))}l.expandByVector(p)}r.boundingBox=l;c=new O.Sphere;l.getCenter(c.center),c.radius=l.min.distanceTo(l.max)/2,r.boundingSphere=c}}return Promise.all(i).then(function(){if(void 0===e.targets)return u;{var r=u,n=e.targets,a=_;let i=!1,s=!1;for(let e=0,t=n.length;e<t;e++){var o=n[e];if(void 0!==o.POSITION&&(i=!0),void 0!==o.NORMAL&&(s=!0),i&&s)break}if(!i&&!s)return Promise.resolve(r);var l=[],h=[];for(let e=0,t=n.length;e<t;e++){var c,d=n[e];i&&(c=void 0!==d.POSITION?a.getDependency("accessor",d.POSITION):r.attributes.position,l.push(c)),s&&(c=void 0!==d.NORMAL?a.getDependency("accessor",d.NORMAL):r.attributes.normal,h.push(c))}return Promise.all([Promise.all(l),Promise.all(h)]).then(function(e){var t=e[0],e=e[1];return i&&(r.morphAttributes.position=t),s&&(r.morphAttributes.normal=e),r.morphTargetsRelative=!0,r})}})}function si(e,t){let i=e.getIndex();if(null===i){var s=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)s.push(e);e.setIndex(s),i=e.getIndex()}var n=i.count-2,a=[];if(t===O.TriangleFanDrawMode)for(let e=1;e<=n;e++)a.push(i.getX(0)),a.push(i.getX(e)),a.push(i.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(a.push(i.getX(e)),a.push(i.getX(e+1)),a.push(i.getX(e+2))):(a.push(i.getX(e+2)),a.push(i.getX(e+1)),a.push(i.getX(e)));a.length/3!=n&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");t=e.clone();return t.setIndex(a),t}const ri=new WeakMap;class ni extends O.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,i,t,s){var r=new O.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,e=>{var t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,t).then(i).catch(s)},t,s)}decodeDracoFile(e,t,i,s){s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,s).then(t)}decodeGeometry(i,s){for(const o in s.attributeTypes){var e=s.attributeTypes[o];void 0!==e.BYTES_PER_ELEMENT&&(s.attributeTypes[o]=e.name)}var t=JSON.stringify(s);if(ri.has(i)){var r=ri.get(i);if(r.key===t)return r.promise;if(0===i.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const a=this.workerNextTaskID++;r=i.byteLength,r=this._getWorker(a,r).then(e=>(n=e,new Promise((e,t)=>{n._callbacks[a]={resolve:e,reject:t},n.postMessage({type:"decode",id:a,taskConfig:s,buffer:i},[i])}))).then(e=>this._createGeometry(e.geometry));return r.catch(()=>!0).then(()=>{n&&a&&this._releaseTask(n,a)}),ri.set(i,{key:t,promise:r}),r}_createGeometry(t){var i=new O.BufferGeometry;t.index&&i.setIndex(new O.BufferAttribute(t.index.array,1));for(let e=0;e<t.attributes.length;e++){var s=t.attributes[e],r=s.name,n=s.array,s=s.itemSize;i.setAttribute(r,new O.BufferAttribute(n,s))}return i}_loadLibrary(i,e){const s=new O.FileLoader(this.manager);return s.setPath(this.decoderPath),s.setResponseType(e),s.setWithCredentials(this.withCredentials),new Promise((e,t)=>{s.load(i,e,void 0,t)})}preload(){return this._initDecoder(),this}_initDecoder(){if(!this.decoderPending){const i="object"!=typeof WebAssembly||"js"===this.decoderConfig.type;var e=[];i?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(e=>{var t=e[0],e=(i||(this.decoderConfig.wasmBinary=e[1]),function(){let i,t;function l(i,s,e,r){var n=r.attributeIDs,a=r.attributeTypes;let o,t;var l=s.GetEncodedGeometryType(e);if(l===i.TRIANGULAR_MESH)o=new i.Mesh,t=s.DecodeBufferToMesh(e,o);else{if(l!==i.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new i.PointCloud,t=s.DecodeBufferToPointCloud(e,o)}if(!t.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+t.error_msg());var h,c,d,u,_,p,m,v,g,E,f,T,w,b,y={index:null,attributes:[]};for(const A in n){var S=self[a[A]];let e,t;if(r.useUniqueIDs)t=n[A],e=s.GetAttributeByUniqueId(o,t);else{if(-1===(t=s.GetAttributeId(o,i[n[A]])))continue;e=s.GetAttribute(o,t)}y.attributes.push((h=i,c=s,d=o,u=A,S=S,_=e,E=g=v=m=p=void 0,p=_.num_components(),m=d.num_points(),v=(m*=p)*S.BYTES_PER_ELEMENT,g=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(h,S),E=h._malloc(v),c.GetAttributeDataArrayForAllPoints(d,_,g,v,E),c=new S(h.HEAPF32.buffer,E,m).slice(),h._free(E),{name:u,array:c,itemSize:p}))}return l===i.TRIANGULAR_MESH&&(y.index=(e=i,l=s,f=o,T=f.num_faces(),w=4*(T*=3),b=e._malloc(w),l.GetTrianglesUInt32Array(f,w,b),l=new Uint32Array(e.HEAPF32.buffer,b,T).slice(),e._free(b),{array:l,itemSize:1})),i.destroy(o),y}onmessage=function(e){const n=e.data;switch(n.type){case"init":i=n.decoderConfig,t=new Promise(function(t){i.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(i)});break;case"decode":const a=n.buffer,o=n.taskConfig;t.then(e=>{var e=e.draco,t=new e.Decoder,i=new e.DecoderBuffer;i.Init(new Int8Array(a),a.byteLength);try{var s=l(e,t,i,o),r=s.attributes.map(e=>e.array.buffer);s.index&&r.push(s.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:s},r)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{e.destroy(i),e.destroy(t)}})}}}.toString()),t=["/* draco decoder */",t,"","/* worker */",e.substring(e.indexOf("{")+1,e.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([t]))})}return this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(e){var t=e.data;switch(t.type){case"decode":i._callbacks[t.id].resolve(t);break;case"error":i._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}class ai{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){var t;this.workers[e]||((t=this.workerCreator()).addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t)}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:i,msg:t,transfer:s}=this.queue.shift();this.workersResolve[e]=i,this.workers[e].postMessage(t,s)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(i,s){return new Promise(e=>{var t=this._getIdleWorker();-1!==t?(this._initWorker(t),this.workerStatus|=1<<t,this.workersResolve[t]=e,this.workers[t].postMessage(i,s)):this.queue.push({resolve:e,msg:i,transfer:s})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const oi=new WeakMap;let li=0;class s extends O.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new ai,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}init(){var e,t;return this.transcoderPending||((e=new O.FileLoader(this.manager)).setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials),e=e.loadAsync("basis_transcoder.js"),(t=new O.FileLoader(this.manager)).setPath(this.transcoderPath),t.setResponseType("arraybuffer"),t.setWithCredentials(this.withCredentials),t=t.loadAsync("basis_transcoder.wasm"),this.transcoderPending=Promise.all([e,t]).then(([e,t])=>{var i=s.BasisWorker.toString(),e=["/* constants */","let _EngineFormat = "+JSON.stringify(s.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(s.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(s.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([e])),this.transcoderBinary=t,this.workerPool.setWorkerCreator(()=>{var e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e})}),0<li&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),li++),this.transcoderPending}load(e,t,i,s){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");var r=new O.FileLoader(this.manager);r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);const n=new O.CompressedTexture;return r.load(e,e=>{if(oi.has(e))return oi.get(e).promise.then(t).catch(s);this._createTexture([e]).then(function(e){n.copy(e),n.needsUpdate=!0,t&&t(n)}).catch(s)},i,s),n}_createTextureFrom(e){var{mipmaps:e,width:t,height:i,format:s,type:r,error:n,dfdTransferFn:a,dfdFlags:o}=e;return"error"===r?Promise.reject(n):((r=new O.CompressedTexture(e,t,i,s,O.UnsignedByteType)).minFilter=1===e.length?O.LinearFilter:O.LinearMipmapLinearFilter,r.magFilter=O.LinearFilter,r.generateMipmaps=!1,r.needsUpdate=!0,r.encoding=2===a?O.sRGBEncoding:O.LinearEncoding,r.premultiplyAlpha=!!(1&o),r)}_createTexture(e,t={}){const i=t;t=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffers:e,taskConfig:i},e)).then(e=>this._createTextureFrom(e.data));return oi.set(e[0],{promise:t}),t}dispose(){return URL.revokeObjectURL(this.workerSourceURL),this.workerPool.dispose(),li--,this}}s.BasisFormat={ETC1S:0,UASTC_4x4:1},s.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},s.EngineFormat={RGBAFormat:O.RGBAFormat,RGBA_ASTC_4x4_Format:O.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:O.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:O.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:O.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:O.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:O.RGB_ETC1_Format,RGB_ETC2_Format:O.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:O.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:O.RGB_S3TC_DXT1_Format},s.BasisWorker=function(){let p,i,m;const v=_EngineFormat,g=_TranscoderFormat,E=_BasisFormat;self.addEventListener("message",function(e){const l=e.data;switch(l.type){case"init":p=l.config,t=l.transcoderBinary,i=new Promise(e=>{m={wasmBinary:t,onRuntimeInitialized:e},BASIS(m)}).then(()=>{m.initializeBasis(),void 0===m.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")});break;case"transcode":i.then(()=>{try{var{width:e,height:t,hasAlpha:i,mipmaps:s,format:r,dfdTransferFn:n,dfdFlags:a}=function(e){const t=new m.KTX2File(new Uint8Array(e));function i(){t.close(),t.delete()}if(!t.isValid())throw i(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");var e=t.isUASTC()?E.UASTC_4x4:E.ETC1S,s=t.getWidth(),r=t.getHeight(),n=t.getLevels(),a=t.getHasAlpha(),o=t.getDFDTransferFunc(),l=t.getDFDFlags(),{transcoderFormat:h,engineFormat:e}=function(t,i,s,r){let n,a;var o=t===E.ETC1S?f:T;for(let e=0;e<o.length;e++){var l=o[e];if(p[l.if]&&(l.basisFormat.includes(t)&&(!l.needsPowerOfTwo||w(i)&&w(s))))return n=l.transcoderFormat[r?1:0],a=l.engineFormat[r?1:0],{transcoderFormat:n,engineFormat:a}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),n=g.RGBA32,a=v.RGBAFormat,{transcoderFormat:n,engineFormat:a}}(e,s,r,a);if(!s||!r||!n)throw i(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!t.startTranscoding())throw i(),new Error("THREE.KTX2Loader: .startTranscoding failed");var c=[];for(let e=0;e<n;e++){var d=t.getImageLevelInfo(e,0,0),u=d.origWidth,d=d.origHeight,_=new Uint8Array(t.getImageTranscodedSizeInBytes(e,0,0,h));if(!t.transcodeImage(_,e,0,0,h,0,-1,-1))throw i(),new Error("THREE.KTX2Loader: .transcodeImage failed.");c.push({data:_,width:u,height:d})}return i(),{width:s,height:r,hasAlpha:a,mipmaps:c,format:e,dfdTransferFn:o,dfdFlags:l}}(l.buffers[0]),o=[];for(let e=0;e<s.length;++e)o.push(s[e].data.buffer);self.postMessage({type:"transcode",id:l.id,width:e,height:t,hasAlpha:i,mipmaps:s,format:r,dfdTransferFn:n,dfdFlags:a},o)}catch(e){console.error(e),self.postMessage({type:"error",id:l.id,error:e.message})}})}var t});var e=[{if:"astcSupported",basisFormat:[E.UASTC_4x4],transcoderFormat:[g.ASTC_4x4,g.ASTC_4x4],engineFormat:[v.RGBA_ASTC_4x4_Format,v.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[g.BC7_M5,g.BC7_M5],engineFormat:[v.RGBA_BPTC_Format,v.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[g.BC1,g.BC3],engineFormat:[v.RGB_S3TC_DXT1_Format,v.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[g.ETC1,g.ETC2],engineFormat:[v.RGB_ETC2_Format,v.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[g.ETC1,g.ETC1],engineFormat:[v.RGB_ETC1_Format,v.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[g.PVRTC1_4_RGB,g.PVRTC1_4_RGBA],engineFormat:[v.RGB_PVRTC_4BPPV1_Format,v.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}];const f=e.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),T=e.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function w(e){return e<=2||0==(e&e-1)&&0!==e}};class hi{constructor({src:e,scenes:t,center:i=$,parser:s=null,animations:r=[],annotations:n=[],variants:a=[],fixSkinnedBbox:o=!1,castShadow:l=!0,receiveShadow:h=!1}){this._src=e;e=new O.Group,e.add(...t),this._scene=e,this._parser=s,this._animations=r,this._annotations=n,this._variants=a,t=this._getInitialBbox(o),s=t.min.y;e.translateY(-s),e.updateMatrixWorld(),t.translate(new O.Vector3(0,-s,0)),this._fixSkinnedBbox=o,this._bbox=t,this._center=i===$?t.getCenter(new O.Vector3):oe(i,t),this.castShadow=l,this.receiveShadow=h}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get annotations(){return this._annotations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}get center(){return this._center}set castShadow(t){this.meshes.forEach(e=>e.castShadow=t)}set receiveShadow(t){this.meshes.forEach(e=>e.receiveShadow=t)}selectVariant(t){return Q(this,void 0,void 0,function*(){var e=this._variants;const s=this._parser;if(!(e.length<=0)&&s){let i=0;null!=t&&(i=n(t)?e.findIndex(({name:e})=>e===t):t);e=this._scene;const r=[];return e.traverse(t=>Q(this,void 0,void 0,function*(){var e;t.isMesh&&t.userData.gltfExtensions&&(e=t.userData.gltfExtensions[we])&&(t.userData.originalMaterial||(t.userData.originalMaterial=t.material),(e=e.mappings.find(e=>e.variants.includes(i)))?(e=s.getDependency("material",e.material),r.push(e),t.material=yield e,s.assignFinalMaterial(t)):t.material=t.userData.originalMaterial)})),Promise.all(r)}})}reduceVertices(n,e){var t=this.meshes;let a=e;return t.forEach(t=>{var i=t.geometry.attributes["position"];if(i)if(t.updateMatrixWorld(),this._fixSkinnedBbox&&t.isSkinnedMesh)this._forEachSkinnedVertices(t,e=>{a=n(a,e)});else{var s=q(i);for(let e=0;e<i.count;e++){var r=(new O.Vector3).fromBufferAttribute(i,e);i.normalized&&r.multiplyScalar(s),r.applyMatrix4(t.matrixWorld),a=n(a,r)}}}),a}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new O.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const t=new O.Box3;return this.meshes.forEach(e=>{e.isSkinnedMesh?this._forEachSkinnedVertices(e,e=>t.expandByPoint(e)):t.expandByObject(e)}),t}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t.sort((e,t)=>e.name.localeCompare(t.name))}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}_forEachSkinnedVertices(t,i){var e=t.geometry,s=e.attributes.position,e=e.attributes.skinWeight,r=(t.skeleton.update(),q(s)),n=q(e);for(let e=0;e<s.count;e++)i(Y(e,t,r,n))}}const ci=new ni,di=new s;class M extends Ee{constructor(e){super(e),this._loader=new Tt;var t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(ci),t.setKTX2Loader(di.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(s){return Q(this,void 0,void 0,function*(){return new Promise((e,t)=>{const i=document.createElement("script");i.addEventListener("load",()=>Q(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,M.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(i),e()})),i.addEventListener("error",()=>{document.body.removeChild(i),t()}),i.src=new URL(s,location.href).href,document.body.appendChild(i)})})}load(s){var e=this._view3D;const r=this._loader,n=X(e,s);return ci.setDecoderPath(e.dracoPath),di.setTranscoderPath(e.ktxPath),M.meshoptDecoder&&r.setMeshoptDecoder(M.meshoptDecoder),r.manager=O.DefaultLoadingManager,new Promise((i,t)=>{try{r.load(s,t=>Q(this,void 0,void 0,function*(){var e=yield this._parseToModel(t,s);i(e)}),e=>this._onLoadingProgress(e,s,n),e=>{n.initialized=!0,t(e)})}catch(e){t(e)}})}loadFromFiles(o){const l=this._view3D,h=this._loader,c=[],d=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return ci.setDecoderPath(l.dracoPath),di.setTranscoderPath(l.ktxPath),M.meshoptDecoder&&h.setMeshoptDecoder(M.meshoptDecoder),new Promise((i,t)=>{if(o.length<=0)t(new Error("No files found"));else{const s=o.find(e=>/\.(gltf|glb)$/i.test(e.name));if(s){const r=new Map,n=(o.forEach(e=>{r.set(e.name,e)}),URL.createObjectURL(s));c.push(n);var e=new O.LoadingManager;e.setURLModifier(e=>{var t;return!/^data:.*,.*$/i.test(e)&&(t=(t=/[^\/|\\]+$/.exec(e))&&t[0]||"",r.has(t))?(t=r.get(t),t=URL.createObjectURL(t),c.push(t),t):e});const a=X(l,n);h.manager=e,h.load(n,t=>Q(this,void 0,void 0,function*(){var e=yield this._parseToModel(t,s.name);d(),i(e)}),e=>this._onLoadingProgress(e,n,a),e=>{a.initialized=!0,d(),t(e)})}else t(new Error("No glTF file found"))}})}_parseToModel(c,d){var u;return Q(this,void 0,void 0,function*(){const r=this._view3D;var e=r.fixSkinnedBbox;c.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const a=r.renderer.threeRenderer.capabilities.maxTextureSize,t=[],o=(c.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&t.push(e)})}),t.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[]).reduce((e,t)=>[...e,...Te.filter(e=>t[e]).map(e=>t[e])],[])),i=c.parser.associations,s=c.parser.json;var n=o.filter(e=>i.has(e)).map(e=>s.textures[i.get(e).textures]),n=Array.from(new Set(n).values()).reduce((s,e,t)=>{var i=e.extensions&&e.extensions[be],r=e.extras&&e.extras[ye];if(i||r){const n=o[t];(i?e.extensions[be]:e.extras[ye]).levels.forEach(({index:e,size:t},i)=>{t>a||(s[i]||(s[i]=[]),s[i].push({index:e,texture:n}))})}return s},[]);const l=n.map(()=>!1);n.forEach((i,s)=>Q(this,void 0,void 0,function*(){var e=yield Promise.all(i.map(({index:e})=>c.parser.getDependency("texture",e))),t=l.slice(s+1).some(e=>!!e);l[s]=!0,t||e.forEach((e,t)=>{t=i[t].texture;t.image=e.image,t.needsUpdate=!0,r.renderer.renderSingleFrame()})}));var n=[],h=(c.parser.json.extras&&c.parser.json.extras[Se]&&(h=c.parser.json.extras[Se],n.push(...r.annotation.parse(h))),null!=(u=c.userData)?u:{}),h=null!=(u=h.gltfExtensions)?u:{},h=h[we]?h[we].variants:[],n=new hi({src:d,scenes:c.scenes,center:r.center,annotations:n,parser:c.parser,animations:c.animations,variants:h,fixSkinnedBbox:e});return r.variant&&(yield n.selectVariant(r.variant)),n})}}class ui extends o{constructor(e,{src:t=null,iosSrc:i=null,variant:s=null,dracoPath:r="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:n="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:a=null,fixSkinnedBbox:o=!1,fov:l=$,center:h=$,yaw:c=0,pitch:d=0,pivot:u=$,initialZoom:_=0,rotate:p=!0,translate:m=!0,zoom:v=!0,autoplay:g=!1,scrollable:E=!0,wheelScrollable:f=!1,useGrabCursor:T=!0,ignoreCenterOnFit:w=!1,skybox:b=null,envmap:y=null,background:S=null,exposure:A=1,shadow:L=!0,skyboxBlur:R=!1,toneMapping:x=ue.LINEAR,useDefaultEnv:O=!0,defaultAnimationIndex:C=0,animationRepeatMode:M=me.ONE,annotationURL:I=null,annotationWrapper:D="."+J.ANNOTATION_WRAPPER,annotationSelector:F="."+J.ANNOTATION,annotationBreakpoints:U=Pe,annotationAutoUnfocus:B=!0,webAR:k=!0,sceneViewer:H=!0,quickLook:G=!0,arPriority:V=Ne,poster:z=null,canvasSelector:W="canvas",autoInit:P=!0,autoResize:j=!0,useResizeObserver:K=!0,maintainSize:X=!1,on:q={},plugins:N=[],maxDeltaTime:Y=1/30}={}){super(),this._rootEl=ee(e),this._src=t,this._iosSrc=i,this._variant=s,this._dracoPath=r,this._ktxPath=n,this._meshoptPath=a,this._fixSkinnedBbox=o,this._fov=l,this._center=h,this._yaw=c,this._pitch=d,this._pivot=u,this._initialZoom=_,this._rotate=p,this._translate=m,this._zoom=v,this._autoplay=g,this._scrollable=E,this._wheelScrollable=f,this._useGrabCursor=T,this._ignoreCenterOnFit=w,this._skybox=b,this._envmap=y,this._background=S,this._exposure=A,this._shadow=L,this._skyboxBlur=R,this._toneMapping=x,this._useDefaultEnv=O,this._defaultAnimationIndex=C,this._animationRepeatMode=M,this._annotationURL=I,this._annotationWrapper=D,this._annotationSelector=F,this._annotationBreakpoints=U,this._annotationAutoUnfocus=B,this._webAR=k,this._sceneViewer=H,this._quickLook=G,this._arPriority=V,this._poster=z,this._canvasSelector=W,this._autoInit=P,this._autoResize=j,this._useResizeObserver=K,this._maintainSize=X,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=N,this._maxDeltaTime=Y,this._renderer=new ve(this),this._camera=new Ue(this),this._control=new Et(this),this._scene=new Ce(this),this._animator=new ke(this),this._autoPlayer=new ft(this,Z(g)),this._autoResizer=new Be(this),this._arManager=new ct(this),this._annotationManager=new pt(this),this._addEventHandlers(q),this._addPosterImage(),Q(this,void 0,void 0,function*(){yield this._initPlugins(N),t&&P&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get annotation(){return this._annotationManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get variant(){return this._variant}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get pivot(){return this._pivot}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get ignoreCenterOnFit(){return this._ignoreCenterOnFit}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get useDefaultEnv(){return this._useDefaultEnv}get defaultAnimationIndex(){return this._defaultAnimationIndex}get animationRepeatMode(){return this._animationRepeatMode}get annotationURL(){return this._annotationURL}get annotationWrapper(){return this._annotationWrapper}get annotationSelector(){return this._annotationSelector}get annotationBreakpoints(){return this._annotationBreakpoints}get annotationAutoUnfocus(){return this._annotationAutoUnfocus}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maintainSize(){return this._maintainSize}get maxDeltaTime(){return this._maxDeltaTime}set iosSrc(e){this._iosSrc=e}set variant(e){this._model&&this._model.selectVariant(e).then(()=>{this.renderer.renderSingleFrame()}),this._variant=e}set defaultAnimationIndex(e){this._defaultAnimationIndex=e}set initialZoom(e){this._initialZoom=e}set skybox(e){this._scene.setSkybox(e),!(this._skybox=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set envmap(e){this._scene.setEnvMap(e),!(this._envmap=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set exposure(e){this._exposure=e,this._renderer.threeRenderer.toneMappingExposure=e,this._renderer.renderSingleFrame()}set skyboxBlur(e){this._skyboxBlur=e;var t=this._scene,i=t.root,t=t.root.environment;t&&null!==i.background&&(i.background=e?b.createBlurredHDR(this,t):t)}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e,this._renderer.renderSingleFrame()}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set animationRepeatMode(e){this._animationRepeatMode=e,this._animator.updateRepeatMode()}set autoResize(e){(this._autoResize=e)?this._autoResizer.enable():this._autoResizer.disable()}set maintainSize(e){this._maintainSize=e}set maxDeltaTime(e){this._maxDeltaTime=e}destroy(){this._scene.reset(),this._renderer.destroy(),this._control.destroy(),this._autoResizer.disable(),this._animator.destroy(),this._annotationManager.destroy(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return Q(this,void 0,void 0,function*(){if(!this._src)throw new l(c.PROVIDE_SRC_FIRST,h.PROVIDE_SRC_FIRST);var e=this._scene,t=this._renderer,i=this._control,s=this._animator,r=this._annotationManager,n=this._meshoptPath,a=[],s=(this.resize(),s.init(),r.init(),this._autoResize&&this._autoResizer.enable(),n&&!M.meshoptDecoder&&(yield M.setMeshoptDecoder(n)),a.push(...e.initTextures()),this._loadModel(this._src));a.push(...s),this._resetLoadingContextOnFinish(a),yield Promise.race(s),this._annotationURL&&(yield this._annotationManager.load(this._annotationURL)),i.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),t.renderSingleFrame(),this._initialized=!0,this.trigger(f.READY,{type:f.READY,target:this})})}resize(){var e=this._renderer,t=this._initialized?e.size:null,i=(e.resize(),e.size);this._camera.resize(i,t),this._control.resize(i),this._annotationManager.resize(),this._initialized&&e.renderSingleFrame(!0),this.trigger(f.RESIZE,Object.assign(Object.assign({},i),{type:f.RESIZE,target:this}))}load(t,{iosSrc:i=null}={}){return Q(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t,this._iosSrc=i):(this._src=t,this._iosSrc=i,yield this.init())})}display(e,{resetCamera:t=!0}={}){var i=this._renderer,s=this._scene,r=this._camera,n=this._animator,a=this._annotationManager,o=i.threeRenderer.xr.isPresenting;s.reset(),s.add(e.scene),s.shadowPlane.updateDimensions(e),t&&(r.fit(e),r.reset(0)),n.reset(),n.setClips(e.animations),0<e.animations.length&&n.play(this._defaultAnimationIndex),a.reset(),a.collect(),a.add(...e.annotations),this._model=e,o&&(s=this._arManager.activeSession)&&s.control.syncTargetModel(e),this._initialized&&i.renderSingleFrame(),this.trigger(f.MODEL_CHANGE,{type:f.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return Q(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return Q(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){var t=this._renderer.canvas.toDataURL("png"),i=document.createElement("a");i.href=t,i.download=e,i.click()}_loadModel(e){const i=new M(this);if(Array.isArray(e)){const s=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(i,e,t,s))}return[this._loadSingleModel(i,e,0,[!1])]}_loadSingleModel(r,n,a,o){return Q(this,void 0,void 0,function*(){var t=o.length-1;this.trigger(f.LOAD_START,{type:f.LOAD_START,target:this,src:n,level:a,maxLevel:t});try{var e=yield r.load(n),i=o.slice(a+1).some(e=>!!e),s=o.some(e=>!!e);this.trigger(f.LOAD,{type:f.LOAD,target:this,model:e,level:a,maxLevel:t}),o[a]=!0,i||this.display(e,{resetCamera:!s})}catch(e){throw this.trigger(f.LOAD_ERROR,{type:f.LOAD_ERROR,target:this,level:a,maxLevel:t,error:e}),new l(c.MODEL_FAIL_TO_LOAD(n),h.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const i=this._rootEl;if(t){var s=N(t);let e;if(s||B(t)){s=s?t:i.querySelector(t);if(!s)throw new l(c.ELEMENT_NOT_FOUND(t),h.ELEMENT_NOT_FOUND);e=s}else{const r=document.createElement("img");r.className=J.POSTER,r.src=t,i.appendChild(r),e=r,this.once(f.READY,()=>{r.parentElement===i&&i.removeChild(r)})}this.once(f.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return Q(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return Q(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(f.LOAD_FINISH,{type:f.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}ui.VERSION="2.10.1";class _i{constructor({className:e={},showPlaneDetection:t=!0,toastText:i="Point your device downwards to find the ground and move it around."}={}){this.className=e,this.showPlaneDetection=t,this.toastText=i,this._createElements()}init(l){return Q(this,void 0,void 0,function*(){const r=this._rootEl,n=this._detectionRootEl,a=this._closeButtonEl,o=Object.assign(Object.assign({},_i.DEFAULT_CLASS),this.className);l.on(f.AR_START,({session:e})=>{var t=e.domOverlay.root;if(t){t.appendChild(r);const i=()=>{e.exit()},s=(null!==n&&void 0!==n&&n.classList.add(o.DETECTION_VISIBLE),()=>{null!==n&&void 0!==n&&n.classList.remove(o.DETECTION_VISIBLE)});l.once(f.AR_MODEL_PLACED,s),a.addEventListener(m.CLICK,i),l.once(f.AR_END,()=>{r.parentElement&&r.parentElement.removeChild(r),a.removeEventListener(m.CLICK,i),l.off(f.AR_MODEL_PLACED,s)})}})})}teardown(){}_createElements(){var e=Object.assign(Object.assign({},_i.DEFAULT_CLASS),this.className),t=document.createElement(E),i=document.createElement(E);i.classList.add(e.CLOSE_BUTTON),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',t.classList.add(e.ROOT),t.appendChild(i),this.showPlaneDetection&&(this._detectionRootEl=this._createPlaneDetectionElements(),t.appendChild(this._detectionRootEl)),this._rootEl=t,this._closeButtonEl=i}_createPlaneDetectionElements(){const t=Object.assign(Object.assign({},_i.DEFAULT_CLASS),this.className);var e=document.createElement(E),i=document.createElement(E),s=document.createElement(E),r=document.createElement(E);const n=document.createElement(E);var a=document.createElement(E),o=k(5).map(()=>document.createElement(E));return e.classList.add(t.DETECTION_ROOT),i.classList.add(t.DETECTION_ICON),s.classList.add(t.DETECTION_TOAST),r.classList.add(t.DETECTION_PHONE),n.classList.add(t.DETECTION_CUBE),a.classList.add(t.DETECTION_PLANE),s.innerHTML=this.toastText,o.forEach(e=>{e.classList.add(t.DETECTION_CUBE_FACE),n.appendChild(e)}),i.appendChild(r),i.appendChild(n),i.appendChild(a),e.appendChild(i),e.appendChild(s),e}}_i.DEFAULT_CLASS={ROOT:"view3d-ar-root",CLOSE_BUTTON:"view3d-ar-close",DETECTION_ROOT:"view3d-ar-detection",DETECTION_ICON:"view3d-ar-detection-icon",DETECTION_TOAST:"view3d-ar-detection-toast",DETECTION_PHONE:"view3d-ar-phone",DETECTION_CUBE:"view3d-ar-cube",DETECTION_CUBE_FACE:"view3d-ar-cube-face",DETECTION_PLANE:"view3d-ar-plane",DETECTION_VISIBLE:"visible"};class I{constructor(e={}){this._startLoading=({target:s,level:e})=>{if(0!==e)return;const{type:t=I.TYPE.DEFAULT,loadingLabel:i="Loading 3D Model...",parsingLabel:r="Parsing 3D Model...",labelColor:n="#ffffff",barWidth:a="70%",barHeight:o="10px",barBackground:l="#bbbbbb",barForeground:h="#3e8ed0",spinnerWidth:c="30%",overlayBackground:d="rgba(0, 0, 0, 0.3)"}=this._options;var e=document.createElement(E),u=document.createElement(E);const _=document.createElement(E);var p=document.createElement(E);const m=document.createElement(E);var v=Object.assign(Object.assign({},this._options.className),I.DEFAULT_CLASS);if(e.classList.add(v.OVERLAY),u.classList.add(v.WRAPPER),p.classList.add(v.BASE),_.classList.add(v.LABEL),m.classList.add(v.FILLER),e.style.backgroundColor=d,t!==I.TYPE.SPINNER?(p.style.height=o,p.style.backgroundColor=l,m.style.backgroundColor=h):(p.classList.add(v.TYPE_SPINNER),p.style.width=c,p.style.paddingTop=c,m.style.borderWidth=o,m.style.borderColor=h,m.style.borderLeftColor="transparent"),t===I.TYPE.TOP?e.classList.add(v.TYPE_TOP):t===I.TYPE.DEFAULT&&(p.style.width=a),_.style.color=n,_.innerText=i,p.appendChild(m),u.appendChild(p),u.appendChild(_),e.appendChild(u),s.rootEl.appendChild(e),t!==I.TYPE.SPINNER){const g=()=>{var e,t,i;s.loadingContext.every(e=>e.initialized)&&([e,t]=s.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]),t<=0||(i=e/t*100,m.style.width=i.toFixed(2)+"%",e===t&&(_.innerText=r)))};s.on(f.PROGRESS,g),s.once(f.LOAD_FINISH,()=>{s.off(f.PROGRESS,g)})}s.once(f.LOAD_FINISH,()=>{this._removeOverlay(s)}),this._overlay=e},this._options=e}init(e){return Q(this,void 0,void 0,function*(){e.on(f.LOAD_START,this._startLoading)})}teardown(e){e.off(f.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}I.DEFAULT_CLASS={OVERLAY:"view3d-lb-overlay",WRAPPER:"view3d-lb-wrapper",BASE:"view3d-lb-base",LABEL:"view3d-lb-label",FILLER:"view3d-lb-filler",TYPE_SPINNER:"is-spinner",TYPE_TOP:"is-top"},I.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};class pi{constructor(e,t,{position:i=D.POSITION.TOP,order:s=9999}={}){this._onResize=()=>{this._rootBbox=this._trackEl.getBoundingClientRect()},this._onRender=({target:e})=>{var e=e.animator,t=e.activeAnimationIndex,i=e.activeAnimation,e=e.actions[t];i&&e&&(t=e.time/i.duration,this._fill(t))},this._onMouseDown=e=>{var t,i;e.button===ne.LEFT&&(t=(i=this._view3D.animator).activeAnimationIndex,i=i.actions[t],e.preventDefault(),window.addEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1),this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._origTimeScale=i.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX))},this._onMouseMove=e=>{e.preventDefault(),this._updateAnimationProgress(e.pageX)},this._onMouseUp=()=>{window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)},this._onTouchStart=e=>{var t,i;1<e.touches.length||(e=e.touches[0],t=(i=this._view3D.animator).activeAnimationIndex,i=i.actions[t],this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._firstTouch={x:e.pageX,y:e.pageY},this._origTimeScale=i.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX))},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],i=this._view3D.scrollable,s=this._firstTouch;if(s){if(i){i=new O.Vector2(t.pageX,t.pageY).sub(new O.Vector2(s.x,s.y));if(Math.abs(i.y)>Math.abs(i.x))return this._scrolling=!0,void this._release()}this._firstTouch=null}e.cancelable&&e.preventDefault(),e.stopPropagation(),this._setAnimationTimeScale(0),this._updateAnimationProgress(t.pageX)}},this._onTouchEnd=e=>{0<e.touches.length||(this._release(),this._scrolling=!1)},this._updateAnimationProgress=e=>{var t=this._view3D,i=this._rootBbox,s=this._thumbEl,r=t.animator,n=r.activeAnimationIndex,a=r.activeAnimation,r=r.actions[n];a&&r&&(n=(e-i.x)/i.width,e=d(n,0,1)*a.duration,r.time=e,i=Math.floor(e),n=Math.floor(100*(e-i)),s.setAttribute("data-time",(a=e=>""+"0".repeat(Math.max(2-e.toString().length,0))+e)(i)+":"+a(n)),t.renderer.renderSingleFrame())},this.position=i,this.order=s,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1,this._firstTouch=null,this._scrolling=!1,this._origTimeScale=1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){var e=this._view3D;this._enabled||(this._rootBbox=this._trackEl.getBoundingClientRect(),this._enabled=!0,e.on(f.RESIZE,this._onResize),e.on(f.RENDER,this._onRender),this._fill(0),this.enableInput())}disable(){var e=this._view3D;this._enabled&&(this._enabled=!1,e.off(f.RESIZE,this._onResize),e.off(f.RENDER,this._onRender),this.disableInput())}enableInput(){var e=this._rootEl,t=this._view3D;this._firstTouch=null,this._scrolling=!1,t.animator.animationCount<=0||(e.addEventListener(m.MOUSE_DOWN,this._onMouseDown),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd))}disableInput(){var e=this._rootEl;e.removeEventListener(m.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(m.TOUCH_END,this._onTouchEnd)}_createElements(){var e=this._controlBar,e=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS),t=document.createElement(E),i=(t.classList.add(e.PROGRESS_ROOT),t.draggable=!1,document.createElement(E)),s=(i.classList.add(e.PROGRESS_TRACK),document.createElement(E)),r=(s.classList.add(e.PROGRESS_THUMB),document.createElement(E));r.classList.add(e.PROGRESS_FILLER),i.appendChild(r),i.appendChild(s),t.appendChild(i),this._rootEl=t,this._trackEl=i,this._thumbEl=s,this._fillerEl=r}_fill(e){this._fillerEl.style.width=100*e+"%",this._thumbEl.style.transform=`translateX(${e*this._rootBbox.width}px)`}_release(){this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)}_showThumb(){var e=this._thumbEl,t=this._controlBar,t=Object.assign(Object.assign({},t.className),D.DEFAULT_CLASS);e.classList.add(t.VISIBLE)}_hideThumb(){var e=this._thumbEl,t=this._controlBar,t=Object.assign(Object.assign({},t.className),D.DEFAULT_CLASS);e.classList.remove(t.VISIBLE)}_setAnimationTimeScale(e){var t=this._view3D.animator,i=t.activeAnimationIndex,s=t.activeAnimation,t=t.actions[i];s&&t&&t.setEffectiveTimeScale(e)}}var mi='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M16 37.85V9.85L38 23.85Z"/></svg>';class vi{constructor(e,t,{position:i=D.POSITION.LEFT,order:s=9999}={}){this._updateIcon=()=>{var e=this._view3D;e.animator.paused!==this._paused&&(this._paused=e.animator.paused,this._element.innerHTML=this._paused?mi:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M28.25 38V10H36V38ZM12 38V10H19.75V38Z"/></svg>')},this._onClick=()=>{var e=this._view3D.animator;e.paused?e.resume():e.pause(),this._updateIcon()},this.position=i,this.order=s,this._view3D=e,this._element=this._createButton(t),this._enabled=!1,this._paused=!0}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.on(f.RENDER,this._updateIcon),this._element.addEventListener(m.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(f.RENDER,this._updateIcon),this._element.removeEventListener(m.CLICK,this._onClick),this._enabled=!1)}_createButton(e){var t=document.createElement(ce),e=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML=mi,t}}class gi{constructor(e,t,{position:i=D.POSITION.LEFT,order:s=9999}={}){this._updateAnimations=()=>{var e=this._view3D,t=this._controlBar;const r=e.animator;e=this._rootEl;const i=this._nameEl,n=this._itemListEl;var s=r.clips;const a=Object.assign(Object.assign({},t.className),D.DEFAULT_CLASS);for(;n.firstChild;)n.removeChild(n.firstChild);if(s.length<=0)e.classList.add(a.DISABLED);else{e.classList.remove(a.DISABLED);const o=s.map(e=>{var t=document.createElement(E);return t.classList.add(a.ANIMATION_ITEM),t.innerHTML=e.name,t}),l=(e,t)=>{o[t].classList.add(a.ANIMATION_SELECTED),i.innerHTML=e.name};s.forEach((i,s)=>{var e=o[s];s===r.activeAnimationIndex&&l(i,s),e.addEventListener(m.CLICK,e=>{var t=r.paused;r.play(s),t&&r.pause(),o.forEach(e=>{e.classList.remove(a.ANIMATION_SELECTED)}),l(i,s),this._hideList(),e.stopPropagation()}),n.appendChild(e)})}},this._toggleList=e=>{var t=this._controlBar,i=this._itemListEl,t=Object.assign(Object.assign({},t.className),D.DEFAULT_CLASS);i.classList.toggle(t.VISIBLE),i.classList.contains(t.VISIBLE)&&this._view3D.rootEl.addEventListener(m.CLICK,this._hideList),e.stopPropagation()},this._hideList=()=>{var e=this._controlBar,t=this._itemListEl,e=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS);t.classList.contains(e.VISIBLE)&&t.classList.remove(e.VISIBLE)},this.position=i,this.order=s,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.initialized&&this._updateAnimations(),this._view3D.on(f.MODEL_CHANGE,this._updateAnimations),this._nameEl.addEventListener(m.CLICK,this._toggleList),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(f.MODEL_CHANGE,this._updateAnimations),this._view3D.rootEl.removeEventListener(m.CLICK,this._hideList),this._nameEl.removeEventListener(m.CLICK,this._toggleList),this._enabled=!1)}_createElements(){var e=this._controlBar,t=document.createElement(E),i=document.createElement(E),s=document.createElement(E),e=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS);t.classList.add(e.CONTROLS_ITEM),t.classList.add(e.DISABLED),i.classList.add(e.ANIMATION_NAME),s.classList.add(e.ANIMATION_LIST),t.appendChild(i),t.appendChild(s),this._rootEl=t,this._nameEl=i,this._itemListEl=s}}const Ei=["requestFullscreen","webkitRequestFullscreen","webkitRequestFullScreen","webkitCancelFullScreen","mozRequestFullScreen","msRequestFullscreen"],fi=["fullscreenElement","webkitFullscreenElement","webkitCurrentFullScreenElement","mozFullScreenElement","msFullscreenElement"],Ti=["exitFullscreen","webkitExitFullscreen","webkitCancelFullScreen","mozCancelFullScreen","msExitFullscreen"];class wi{constructor(e,t,{position:i=D.POSITION.RIGHT,order:s=9999}={}){this._onClick=()=>{var e=this._view3D.rootEl;this._isFullscreen()?this._exitFullscreen():this._requestFullscreen(e)},this.position=i,this.order=s,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(m.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(m.CLICK,this._onClick),this._enabled=!1)}_isFullscreen(){if(document)for(const e of fi)if(document[e])return!0;return!1}_requestFullscreen(e){for(const i of Ei){var t=e[i];t&&t.call(e)}}_exitFullscreen(){for(const t of Ti){var e=document[t];e&&e.call(document)}}_createButton(e){var t=document.createElement(ce),e=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M10 38v-9.65h3V35h6.65v3Zm0-18.35V10h9.65v3H13v6.65ZM28.35 38v-3H35v-6.65h3V38ZM35 19.65V13h-6.65v-3H38v9.65Z"/></svg>',t}}class bi{constructor(e,t,{axisWidth:i=5,font:s="14px sans-serif",xAxisColor:r="#ef2746",yAxisColor:n="#a7c031",zAxisColor:a="#6571a6"}={}){this._onRender=()=>{var e=this._view3D;const o=this._ctx;var t=this._canvasSize,i=e.camera.threeCamera;if(o&&e.model){o.clearRect(0,0,t.x,t.y);var e=i.quaternion.clone(),i=(e.invert(),new O.Vector3(1,0,0).applyQuaternion(e)),s=new O.Vector3(0,1,0).applyQuaternion(e),e=new O.Vector3(0,0,1).applyQuaternion(e);const l=new O.Vector2(.5,.5).multiply(t);o.lineCap="round",o.lineWidth=this.axisWidth;var t=new O.Color(this.xAxisColor),r=new O.Color(this.yAxisColor),n=new O.Color(this.zAxisColor);[{idx:0,axis:"X",color:t,pos:i,negative:!1},{idx:1,axis:"Y",color:r,pos:s,negative:!1},{idx:2,axis:"Z",color:n,pos:e,negative:!1},{idx:3,axis:"X",color:t,pos:i.clone().negate(),negative:!0},{idx:4,axis:"Y",color:r,pos:s.clone().negate(),negative:!0},{idx:5,axis:"Z",color:n,pos:e.clone().negate(),negative:!0}].sort((e,t)=>e.pos.z-t.pos.z).forEach(({axis:e,pos:t,color:i,negative:s,idx:r},n)=>{var a=this._getScreenPos(t),t=0<=t.z?1:.6,i=this._getColorRGBAString(i,t),t=(s||(o.strokeStyle=i,o.beginPath(),o.moveTo(l.x,l.y),o.lineTo(a.x,a.y),o.stroke(),o.globalCompositeOperation="destination-out",o.fillStyle="white",o.beginPath(),o.ellipse(a.x,a.y,10,10,0,0,2*Math.PI),o.fill(),o.globalCompositeOperation="source-over"),o.fillStyle=i,o.beginPath(),o.ellipse(a.x,a.y,10,10,0,0,2*Math.PI),o.fill(),s||(o.font=this.font,o.fillStyle="white",o.textAlign="center",o.textBaseline="middle",o.fillText(e,a.x,a.y)),this._axisEls[r]);t.style.left=a.x+"px",t.style.top=a.y+"px",t.style.zIndex=n.toString()})}},this.axisWidth=i,this.font=s,this.xAxisColor=r,this.yAxisColor=n,this.zAxisColor=a,this._view3D=e,this._createElement(t),this._ctx=this._canvasEl.getContext("2d"),this._enabled=!1,this._canvasSize=new O.Vector2}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){if(!this._enabled&&this._ctx){var e=this._rootEl,t=this._canvasEl;const s=this._view3D,r=(this._enabled=!0,s.rootEl.appendChild(e),s.on(f.RENDER,this._onRender),this._canvasSize.set(t.clientWidth,t.clientHeight),t.width=this._canvasSize.x,t.height=this._canvasSize.y,[new A(-90,0,0),new A(0,90,0),new A(0,0,0),new A(90,0,0),new A(0,-90,0),new A(180,0,0)]);r.forEach(e=>{e.pivot.copy(s.camera.defaultPose.pivot)}),this._axisClickListeners=this._axisEls.map((e,t)=>{const i=r[t];t=()=>{s.camera.reset(300,y,i)};return e.addEventListener(m.CLICK,t),t})}}disable(){var e,t;this._enabled&&(this._enabled=!1,e=this._view3D.rootEl,(t=this._rootEl)&&t.parentElement===e&&e.removeChild(t),this._view3D.off(f.RENDER,this._onRender),this._axisEls.forEach((e,t)=>{t=this._axisClickListeners[t];e.removeEventListener(m.CLICK,t)}),this._axisClickListeners=[])}_createElement(e){const t=document.createElement(E);var i=document.createElement("canvas"),s=k(6).map(()=>document.createElement(E));const r=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS);t.classList.add(r.GIZMO_ROOT),t.appendChild(i),s.forEach(e=>{e.classList.add(r.GIZMO_AXIS),t.appendChild(e)}),this._rootEl=t,this._canvasEl=i,this._axisEls=s}_getScreenPos(e){var t=this._canvasSize;return new O.Vector2(e.x,-e.y).multiplyScalar(.8).addScalar(1).multiplyScalar(.5).multiply(t)}_getColorRGBAString(e,t){return`rgba(${Math.floor(255*e.r)},${Math.floor(255*e.g)},${Math.floor(255*e.b)},${t})`}}class yi{constructor(e,t,{position:i=D.POSITION.RIGHT,order:s=9999,duration:r=500}={}){this._onClick=()=>{this._view3D.camera.reset(this.duration)},this.position=i,this.order=s,this.duration=r,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(m.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(m.CLICK,this._onClick),this._enabled=!1)}_createButton(e){var t=document.createElement(ce),e=Object.assign(Object.assign({},e.className),D.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M24 44q-3.75 0-7.025-1.4-3.275-1.4-5.725-3.85Q8.8 36.3 7.4 33.025 6 29.75 6 26h3q0 6.25 4.375 10.625T24 41q6.25 0 10.625-4.375T39 26q0-6.25-4.25-10.625T24.25 11H23.1l3.65 3.65-2.05 2.1-7.35-7.35 7.35-7.35 2.05 2.05-3.9 3.9H24q3.75 0 7.025 1.4 3.275 1.4 5.725 3.85 2.45 2.45 3.85 5.725Q42 22.25 42 26q0 3.75-1.4 7.025-1.4 3.275-3.85 5.725-2.45 2.45-5.725 3.85Q27.75 44 24 44Z"/></svg>',t}}class D{constructor({autoHide:e=!0,className:t={},progressBar:i=!0,playButton:s=!0,animationSelector:r=!0,fullscreenButton:n=!0,navigationGizmo:a=!0,cameraResetButton:o=!0}={}){this.show=()=>{var e=this._rootEl,t=Object.assign(Object.assign({},D.DEFAULT_CLASS),this.className);e.classList.add(t.VISIBLE)},this.hide=()=>{var e=this._rootEl,t=Object.assign(Object.assign({},D.DEFAULT_CLASS),this.className);e.classList.remove(t.VISIBLE)},this._updateModelParams=()=>{this._items.forEach(e=>{e.disable(),e.enable()})},this._hideAfterDelay=()=>{var{delay:e=0}=Z(this.autoHide);this._autoHideTimer&&(window.clearTimeout(this._autoHideTimer),this._autoHideTimer=-1),e<=0?this.hide():this._autoHideTimer=window.setTimeout(this.hide,e)},this.autoHide=e,this.className=t,this.progressBar=i,this.playButton=s,this.animationSelector=r,this.fullscreenButton=n,this.navigationGizmo=a,this.cameraResetButton=o,this._items=[],this._initElements(),this._autoHideTimer=-1}get rootEl(){return this._rootEl}get items(){return this._items}init(e){return Q(this,void 0,void 0,function*(){this._attachElements(e),e.model&&this._updateModelParams(),this._items=this._createDefaultItems(e),this._addItemElements(),this._items.forEach(e=>{e.enable()}),e.on(f.MODEL_CHANGE,this._updateModelParams),this.show(),this._setupAutoHide(e)})}teardown(e){var t=e.rootEl;t.removeEventListener(m.POINTER_ENTER,this.show),t.removeEventListener(m.POINTER_LEAVE,this._hideAfterDelay),this._removeElements(e),this._items.forEach(e=>{e.disable()}),this._items=[],e.off(f.MODEL_CHANGE,this._updateModelParams),window.clearTimeout(this._autoHideTimer)}_initElements(){var e=Object.assign(Object.assign({},D.DEFAULT_CLASS),this.className),t=document.createElement(E),i=(t.classList.add(e.ROOT),this._rootEl=t,document.createElement(E)),i=(i.classList.add(e.CONTROLS_BG),t.appendChild(i),document.createElement(E)),s=document.createElement(E),r=document.createElement(E),n=document.createElement(E);i.classList.add(e.CONTROLS_TOP),s.classList.add(e.CONTROLS_SIDE),r.classList.add(e.CONTROLS_LEFT),n.classList.add(e.CONTROLS_RIGHT),t.appendChild(i),s.appendChild(r),s.appendChild(n),t.appendChild(s),this._topControlsWrapper=i,this._leftControlsWrapper=r,this._rightControlsWrapper=n}_addItemElements(){var e=this._topControlsWrapper,t=this._leftControlsWrapper,i=this._rightControlsWrapper,s=this._items.filter(e=>e.position&&null!=e.order);const r={[D.POSITION.TOP]:{parentEl:e,items:[]},[D.POSITION.LEFT]:{parentEl:t,items:[]},[D.POSITION.RIGHT]:{parentEl:i,items:[]}};s.forEach(e=>{r[e.position].items.push(e)}),Object.keys(r).forEach(e=>{const{parentEl:t,items:i}=r[e];i.sort((e,t)=>e.order-t.order),i.forEach(e=>{t.appendChild(e.element)})})}_attachElements(e){e.rootEl.appendChild(this._rootEl)}_removeElements(e){var t=this._rootEl;[this._topControlsWrapper,this._leftControlsWrapper,this._rightControlsWrapper].forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)}),t.parentElement===e.rootEl&&e.rootEl.removeChild(t)}_setupAutoHide(e){var t;this.autoHide&&({initialDelay:t=3e3}=Z(this.autoHide),e=e.rootEl,this._autoHideTimer=window.setTimeout(()=>{this.hide()},t),e.addEventListener(m.POINTER_ENTER,this.show),e.addEventListener(m.POINTER_LEAVE,this._hideAfterDelay))}_createDefaultItems(e){var t=[];return this.progressBar&&t.push(new pi(e,this,Z(this.progressBar))),this.playButton&&t.push(new vi(e,this,Z(this.playButton))),this.animationSelector&&t.push(new gi(e,this,Z(this.animationSelector))),this.cameraResetButton&&t.push(new yi(e,this,Z(this.cameraResetButton))),this.fullscreenButton&&t.push(new wi(e,this,Z(this.fullscreenButton))),this.navigationGizmo&&t.push(new bi(e,this,Z(this.navigationGizmo))),t}}D.DEFAULT_CLASS={ROOT:"view3d-control-bar",VISIBLE:"visible",DISABLED:"disabled",CONTROLS_BG:"view3d-controls-background",CONTROLS_SIDE:"view3d-side-controls",CONTROLS_TOP:"view3d-top-controls",CONTROLS_LEFT:"view3d-left-controls",CONTROLS_RIGHT:"view3d-right-controls",CONTROLS_ITEM:"view3d-control-item",PROGRESS_ROOT:"view3d-progress-bar",PROGRESS_TRACK:"view3d-progress-track",PROGRESS_THUMB:"view3d-progress-thumb",PROGRESS_FILLER:"view3d-progress-filler",ANIMATION_NAME:"view3d-animation-name",ANIMATION_LIST:"view3d-animation-list",ANIMATION_ITEM:"view3d-animation-item",ANIMATION_SELECTED:"selected",GIZMO_ROOT:"view3d-gizmo",GIZMO_AXIS:"view3d-gizmo-axis"},D.POSITION={TOP:"top",LEFT:"left",RIGHT:"right"};var t={__proto__:null,default:ui,Animation:He,ARManager:ct,AutoPlayer:ft,AutoResizer:Be,Camera:Ue,Model:hi,ModelAnimator:ke,Motion:S,Pose:A,Renderer:ve,Scene:Ce,ShadowPlane:Re,Skybox:b,View3DError:l,Annotation:dt,PointAnnotation:ut,FaceAnnotation:_t,AnnotationManager:pt,AnimationControl:Fe,OrbitControl:Et,RotateControl:mt,TranslateControl:vt,ZoomControl:gt,Loader:Ee,GLTFLoader:M,TextureLoader:fe,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return Q(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(o){return Q(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:i="view3d-ar-button",tooltipClass:s="view3d-tooltip"}=this._options;const r=yield o.ar.isAvailable(),n=document.createElement(ce);var a=document.createElement(E),e=document.createTextNode(r?e:t);n.classList.add(i),a.classList.add(s),n.disabled=!0,n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',n.appendChild(a),a.appendChild(e),o.rootEl.appendChild(n),this._button=n,o.initialized?yield this._setAvailable(o,n,r):o.once(f.MODEL_CHANGE,()=>{this._setAvailable(o,n,r)})})}_setAvailable(e,t,i){return Q(this,void 0,void 0,function*(){i?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:_i,LoadingBar:I,ControlBar:D,AnimationProgressBar:pi,AnimationSelector:gi,FullscreenButton:wi,PlayButton:vi,NavigationGizmo:bi,ARScene:et,WebARSession:at,SceneViewerSession:ot,QuickLookSession:lt,DOMOverlay:tt,HitTest:it,LightEstimation:nt,AUTO:$,EVENTS:f,EASING:de,DEFAULT_CLASS:J,TONE_MAPPING:ue,ZOOM_TYPE:_e,AR_SESSION_TYPE:e,SCENE_VIEWER_MODE:pe,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},INPUT_TYPE:g,ANIMATION_REPEAT_MODE:me,ERROR_CODES:r,isAvailable:({webGL:e=!0,fetch:t=!0,stream:i=!0,wasm:s=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(i&&!(window&&window.ReadableStream))return!1;if(s&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0},withMethods:(r,n)=>{[o.prototype,ui.prototype].forEach(s=>{Object.getOwnPropertyNames(s).filter(e=>"_"!==e.charAt(0)&&"constructor"!==e).forEach(e=>{const i=Object.getOwnPropertyDescriptor(s,e);var t;i.value?Object.defineProperty(r,e,{value:function(...e){return i.value.call(this[n],...e)}}):(t={},i.get&&(t.get=function(){var e;return this[n]&&(null==(e=i.get)?void 0:e.call(this[n]))}),i.set&&(t.set=function(...e){var t;return null==(t=i.set)?void 0:t.call(this[n],...e)}),Object.defineProperty(r,e,t))})})},getValidProps:i=>Object.keys(i).reduce((e,t)=>(null!=i[t]&&(e[t]=i[t]),e),{}),isNumber:P,isString:n,isElement:N,getNullableElement:F,getElement:ee,findCanvas:U,isCSSSelector:B,range:k,toRadian:_,toDegree:p,clamp:d,lerp:H,circulate:u,merge:G,getBoxPoints:e=>[e.min.clone(),new O.Vector3(e.min.x,e.min.y,e.max.z),new O.Vector3(e.min.x,e.max.y,e.min.z),new O.Vector3(e.min.x,e.max.y,e.max.z),new O.Vector3(e.max.x,e.min.y,e.min.z),new O.Vector3(e.max.x,e.min.y,e.max.z),new O.Vector3(e.max.x,e.max.y,e.min.z),e.max.clone()],toPowerOfTwo:V,getPrimaryAxisIndex:(e,i)=>{let s=0,r=0;return e.forEach((e,t)=>{e=Math.abs(i.dot(e));e>r&&(s=t,r=e)}),s},getRotationAngle:z,getObjectOption:Z,toBooleanString:W,getRotatedPosition:j,directionToYawPitch:K,createLoadingContext:X,getAttributeScale:q,getSkinnedVertex:Y,isSignedArrayBuffer:te,checkHalfFloatAvailable:ie,getFaceVertices:se,getAnimatedFace:re,subclip:(e,t,l,h)=>{var i=e.clone();i.name=t;const c=[];i.tracks.forEach(i=>{var s=i.getValueSize(),e=[],r=[];for(let t=0;t<i.times.length;++t){var n=i.times[t],a=i.times[t+1],o=i.times[t-1];if(a&&n<l&&l<a||l<=n&&n<h||o&&h<=n&&o<h){e.push(n);for(let e=0;e<s;++e)r.push(i.values[t*s+e])}}0!==e.length&&(i.times=ae(e,i.times.constructor),i.values=ae(r,i.values.constructor),c.push(i))}),i.tracks=c;for(let e=0;e<i.tracks.length;++e)i.tracks[e].shift(-l);return i.duration=h-l,i},parseAsBboxRatio:oe};return G(ui,t),ui});
